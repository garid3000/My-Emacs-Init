#+startup:      show2levels
#+title:        My Emacs Configuration
#+author:       Garid Z.
#+creator:      Garid Z.
#+email:        garidzorigoo@gmail.com
#+auto_tangle:  t
#+property:     header-args :tangle init.el
#+setupfile:    ~/.config/emacs/org-templates/level-0-xelatex-fonts-conf.org
#+options:      toc:t tags:nil  todo:t  tasks:t
#+html_head:    <link rel="stylesheet" type="text/css" href="https://unpkg.com/chota"/>

* From shell you can run make run
#+begin_src makefile :eval no :tangle Makefile
# make run to extract init.el from init.org from shell
run:
	emacs --batch --eval "(require 'org)" --eval '(org-babel-tangle-file "init.org")'
	chmod +x 'garid/edit_img.sh'
	chmod +x 'garid/open_external_term.sh'
	git submodule foreach git pull origin master

refresh-packages:
	emacs --batch --eval "(setq package-archives '((\"melpa\" . \"https://melpa.org/packages/\") (\"elpa\" . \"https://elpa.gnu.org/packages/\") (\"nongnu\" . \"https://elpa.nongnu.org/nongnu/\")))" --eval "(package-refresh-contents)"
#+end_src

* Package manager:
** Package Repositories
I'm pulling packages from following 3 places (not sure that I need all three):

1. [[https://melpa.org/packages/]]
2. [[https://elpa.gnu.org/packages/]]
3. [[https://elpa.nongnu.org/nongnu/]]

#+begin_src emacs-lisp
;; Package repos
(setq package-archives
      '(("melpa"   . "https://melpa.org/packages/"     )
        ("elpa"    . "https://elpa.gnu.org/packages/"  )
        ("nongnu"  . "https://elpa.nongnu.org/nongnu/" )))
#+end_src

** Initialize use-package manager
#+begin_src emacs-lisp
(package-initialize)
(setq use-package-always-ensure t)
#+end_src

** Straight.el initialization
#+begin_src emacs-lisp
(defvar bootstrap-version)
(let ((bootstrap-file
      (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
        "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
        'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

;;(straight-use-package 'org)
#+end_src

* Vi-movement and its friends
** =vundo=: visual undo

#+begin_src emacs-lisp
(use-package vundo)
#+end_src
** =evil=: vi-movements
#+begin_src emacs-lisp
;; Vim Bindings
(use-package evil
  :ensure t
  :init
  (setq evil-want-keybinding     nil) ;;  these
  (setq evil-want-integration      t) ;;  are for the evil-collection

  :custom
  (evil-undo-system         'undo-redo)
  (evil-toggle-key           "")      ;; removes the C-z toggling evil accidentally
  (evil-want-C-i-jump       t)

  ;; not much related with evil but related to movement
  (scroll-step           1)
  (scroll-margin         7)
  (scroll-conservatively 9999)

  :config
  ;;(evil-define-key 'normal  org-mode-map   (kbd "TAB") #'org-cycle) ;; for org-cycle (tab) working for terminal
  ;;(setq evil-want-C-i-jump       t)
  ;; (evil-define-key 'normal  org-mode-map   (kbd "TAB") #'org-cycle)
  (evil-mode 1)

  (define-key evil-normal-state-map (kbd "SPC a") 'evil-avy-goto-char-2)
  (define-key evil-normal-state-map (kbd "<f3>") 'evil-avy-goto-char-2)

  )
#+end_src
** =evil-collection=: vi-movements everywhere
#+begin_src emacs-lisp
(use-package evil-collection
  :ensure t
  :after evil
  :delight ""
  :config
  (evil-collection-init))
#+end_src

** =evil-surround=: easily surround selected region
I sometimes use. It can wrap (visually) selected region with quotation mark or parenthesis.

#+begin_src emacs-lisp
(use-package evil-surround
  :ensure t
  :after evil
  :hook
  (LaTeX-mode . (lambda ()  ;; adds to latex-mode-hook
                  (push '(40  . ("\\left("       . "\\right)"  )) evil-surround-pairs-alist) ;; ?(
                  (push '(123 . ("\\left\\{"     . "\\right\\}")) evil-surround-pairs-alist) ;; ?{
                  (push '(91  . ("\\left["       . "\\right]"  )) evil-surround-pairs-alist) ;; ?[
                  (push '(47  . ("\\frac{"       . "}{ }"      )) evil-surround-pairs-alist) ;; ?/
                  (push '(63  . ("\\frac{ }{"    . " }"        )) evil-surround-pairs-alist) ;; ??
                  (push '(94  . ("{"             . "}^{ }"     )) evil-surround-pairs-alist) ;; ?^
                  (push '(?b  . ("\\boxed{"      . "}"         )) evil-surround-pairs-alist) ;; ?b
                  (push '(95  . ("\\underbrace{" . "}_{ }"     )) evil-surround-pairs-alist) ;; ?_
                  (push '(45  . ("\\overbrace{"  . "}_{ }"     )) evil-surround-pairs-alist) ;; -
                  ))

  (org-mode . (lambda ()
                (push '(?S  . ("#+begin_src"      . "#+end_src"     )) evil-surround-pairs-alist)
                (push '(?E  . ("#+begin_example"  . "#+end_example" )) evil-surround-pairs-alist)
                (push '(?e  . ("\\("              . "\\)"           )) evil-surround-pairs-alist)
                (push '(?d . (":drawername:"      . ":end:"         )) evil-surround-pairs-alist)
                ))

  (python-base-mode . (lambda ()
                        (push '(?>  . ("#"      . "#"     )) evil-surround-pairs-alist)
                        ))
  :config
  (global-evil-surround-mode)
  )
#+end_src

** =evil-textobj-tree-sitter=: tree-sitter based visual selection:
#+begin_src emacs-lisp
(use-package evil-textobj-tree-sitter
  :ensure t
  :after evil
  :config
  (define-key evil-outer-text-objects-map "f" (evil-textobj-tree-sitter-get-textobj "function.outer" ))
  (define-key evil-inner-text-objects-map "f" (evil-textobj-tree-sitter-get-textobj "function.inner" ))
  (define-key evil-inner-text-objects-map "c" (evil-textobj-tree-sitter-get-textobj "class.inner"    ))
  (define-key evil-outer-text-objects-map "c" (evil-textobj-tree-sitter-get-textobj "class.inner"    ))
  (define-key evil-outer-text-objects-map "a" (evil-textobj-tree-sitter-get-textobj ("conditional.outer" "loop.outer"))))
#+end_src

** repeat
#+begin_src emacs-lisp
(use-package repeat
  :ensure nil  ;; built in
  :config (repeat-mode +1)
  )
#+end_src

*** COMMENT Karthink
This was taken from here [[https://karthinks.com/software/it-bears-repeating/#dot-dot-dot-but-i-repeat-myself]]
but it feels slow when navigating.

#+begin_src emacs-lisp
(setq repeat-echo-function #'ignore)

;; Spawn or hide a which-key popup
(advice-add 'repeat-post-hook :after
            (defun repeat-help--which-key-popup ()
              (if-let ((cmd (or this-command real-this-command))
                       (keymap (or repeat-map
                                   (repeat--command-property 'repeat-map))))
                (run-at-time
                 0 nil
                 (lambda ()
                   (which-key--create-buffer-and-show
                    nil (symbol-value keymap))))
                (which-key--hide-popup))))
#+end_src

** window movmenets
#+begin_src emacs-lisp
(use-package windmove
  :after (window evil)
  :bind (( "M-q"  . delete-window )

         ("M-L" . windmove-right               )
         ("M-H" . windmove-left                )
         ("M-J" . windmove-down                )
         ("M-K" . windmove-up                  )
         ("M-V" . evil-window-vsplit           )
         ("M-S" . evil-window-split            )
         :repeat-map garid/windmove-repeat
         ("M-L"   . windmove-right             )
         ("M-H"   . windmove-left              )
         ("M-J"   . windmove-down              )
         ("M-K"   . windmove-up                )

         ("C-l"   . windmove-swap-states-right )
         ("C-h"   . windmove-swap-states-left  )
         ("C-j"   . windmove-swap-states-down  )
         ("C-k"   . windmove-swap-states-up    )

         ("s"   . evil-window-split            )
         ("v"   . evil-window-vsplit           )
         ("q"   . delete-window                )
         ("="   . balance-windows              )

         ("{"   . shrink-window-horizontally   )
         ("}"   . enlarge-window-horizontally  )
         ("[".    shrink-window                )
         ("]".    enlarge-window               )
         :exit
         ("RET"   . nil                        )
         )
  )
#+end_src

* Theme & colors
** faces
#+begin_src emacs-lisp
(use-package faces
  :ensure nil
  :custom
  (face-font-family-alternatives
   '(("Monospace" "Aporetic Sans Mono" "Iosevka SS06" "Iosevka Term SS06" "Liberation Mono" "courier" "fixed")
     ("Serif" "Aporetic Serif Mono" "Iosevka etoile" "Linux Libertine"  "CMU Serif" "Georgia"  "DejaVu Serif" "serif")
     ))

  :custom-face
  (variable-pitch ((t (:family "Serif"           :height 120))))
  (fixed-pitch    ((t (:family "Monospace"       :height 120))))
  (default        ((t (:family "Monospace"       :height 120))))
  )

(use-package faces-remap
  :ensure nil
  :hook (org-mode . variable-pitch-mode))
#+end_src

** modus theme                                                                            :by_prot:

#+begin_src emacs-lisp
(use-package modus-themes
  :ensure t
  :config
  ;; (setq modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi-tinted))
  (setq modus-themes-to-toggle '(modus-vivendi-tinted modus-operandi-tinted ))

  (setq modus-themes-italic-constructs t
        modus-themes-bold-constructs t
        modus-themes-variable-pitch-ui t
        modus-themes-mixed-fonts t)

  (setq modus-themes-prompts '(bold))
  (setq modus-themes-completions nil)
  (setq modus-themes-org-blocks 'tinted-background) ;'gray-background)
  ;(setq modus-themes-org-blocks  'gray-background)

  (setq modus-themes-headings '((0 . (medium variable-pitch 1.2))
                                (1 . (medium variable-pitch 1.2))
                                (2 . (medium variable-pitch 1.1))
                                (3 . (medium variable-pitch 1.1))
                                (agenda-date . (1.1))
                                (agenda-structure . (variable-pitch light 1.1))
                                (t . (medium variable-pitch 1.0))))


  (customize-set-variable 'modus-themes-common-palette-overrides
                          `(;; Make the mode-line borderless
                            (bg-mode-line-active        bg-inactive )
                            (fg-mode-line-active        fg-main     )
                            (bg-mode-line-inactive      bg-inactive )
                            (fg-mode-line-active        fg-dim      )
                            (border-mode-line-active    bg-inactive )
                            (border-mode-line-inactive  bg-main     )
                            (fringe                     bg-main     )
                            ))


  (defun ct/modus-themes-init ()
    (enable-theme (car modus-themes-to-toggle))

    (scroll-bar-mode       -1)        ; Disable visible scrollbar
    (tool-bar-mode         -1)        ; Disable the toolbar
    (tooltip-mode          -1)        ; Disable tooltips
    (menu-bar-mode         -1)        ; Disable the menu bar
    (setq-default tab-width 4)
    (set-fringe-mode       10)        ; Give some breathing room
    (column-number-mode      )

    (setq-default indent-tabs-mode nil)
    )

  :bind ("<f5>" . modus-themes-toggle)
  :hook (after-init . ct/modus-themes-init))
#+end_src

#+RESULTS:
: modus-themes-toggle

** =delight=
#+begin_src emacs-lisp
(use-package delight
  :ensure t)
#+end_src

** =display-line-numbers=: displaying number
#+begin_src emacs-lisp
;; setting line
(use-package display-line-numbers
  :ensure t
  :custom
  (display-line-numbers-type 'relative)
  (ring-bell-function        'ignore)
  :config
  (global-display-line-numbers-mode -1)
  )
#+end_src

** Line visibility
#+begin_src emacs-lisp
(use-package hl-line
  :ensure nil
  :config
  (global-hl-line-mode 1)
  )

(use-package hl-todo
  :ensure t
  :config
  (global-hl-todo-mode 1)
  )
#+end_src

** =pulsar= pulses on certain functions                                                     :by_prot:
#+begin_src emacs-lisp
(use-package pulsar
  :custom
  (pulsar-delay 0.05)
  (pulsar-iterations 2)
  :config (pulsar-global-mode))
#+end_src

* Mini-buffer completion, selection, suggestion
** =vertico=
#+begin_src emacs-lisp
(use-package vertico
  :ensure t
  :bind (:map vertico-map
              ("M-p" . vertico-previous     )
              ("M-n" . vertico-next         )
              ("M-h" . vertico-exit         )
              ("M-q" . vertico-quick-insert )
              ("C-q" . vertico-quick-exit   ))
  :init
  (require 'vertico-quick)
  :custom
  (vertico-cycle     t  )
  (vertico-count     15 )
  (vertico-resize    nil)
  :config
  (vertico-mode))
#+end_src
** =marginalia=
#+begin_src emacs-lisp
(use-package marginalia
  :after vertico
  :ensure t
  :custom
  (marginalia-annotators '(marginalia-annotators-heavy
                           marginalia-annotators-light nil))
  :init (marginalia-mode))
#+end_src
** =consult=: consulting
#+begin_src emacs-lisp
(use-package consult
  :ensure t
  :custom
  ;;(consult-preview-key nil)
  ;;(consult-preview-key 'any)
  (consult-preview-key (list :debounce 0.5 'any))
  :bind
  ("M-y" . consult-yank-from-kill-ring)
  ("M-f" . consult-line)
  :config
  (defun garid/consult-preview-change ()
    (interactive)
    (setq consult-preview-key 'any)
    (let ((tmp-chose (completing-read "choose" '("nil" "any" "0.5sec"))))
      (when (string= "nil" tmp-chose)    (setq consult-preview-key nil))
      (when (string= "any" tmp-chose)    (setq consult-preview-key 'any))
      (when (string= "0.5sec" tmp-chose) (setq consult-preview-key (list :debounce 0.5 'any)))
      )

    )
  )
#+end_src
** =orderless=: orderless completion
#+begin_src emacs-lisp
(use-package orderless
  :ensure t
  :custom
  (completion-styles '(orderless flex))
  '((file (styles basic partial-completion))))

;;(completion-styles '(orderless basic))
;; (completion-category-overrides
#+end_src
** =embark=: interacting with completion entries
#+begin_src emacs-lisp
(use-package embark
  :ensure t
  :bind (("C-."    . embark-act                                     )
         ("M-."    . embark-dwim                                    )
         ("C-h B"  . embark-bindings                                )

         :map embark-general-map
         ("G"      . my/embark-google-search                        )
         ("t"      . garid/embark-org-insert-ref-of-tbl-fig-src-eq  )
         ("e"      . garid/embark-org-insert-ref-to-label-inside-eq ))

  :init
  (setq prefix-help-command #'embark-prefix-help-command)
  :config

  (defun garid/embark-org-insert-ref-of-tbl-fig-src-eq (x)
    (interactive "sSearch Term: ")
    (insert
     (format "[[%s]]"
             (nth 1 (split-string
                     (replace-regexp-in-string "[^[:alnum:-]]" "" x)
                     )))))

  (defun garid/embark-org-insert-ref-to-label-inside-eq (input-string)
    (interactive "sSearch Term: ")
    (insert
     (format "\\ref{%s}"
             (if (string-match "\\\\label{\\([^}]+\\)}" input-string)
                 (match-string 1 input-string)
               nil
               ))))
  )
#+end_src

** =savehist=:
#+begin_src emacs-lisp
(use-package savehist
  :ensure t
  :config (savehist-mode))
#+end_src
* Org
** =org=: org-mode configuration
#+caption: org config
#+name: lst_org
#+begin_src emacs-lisp :eval no
(use-package org
  :demand t
  :delight "org"
  :bind (:map org-mode-map
              ("C-S-k"     . org-previous-visible-heading    )
              ("C-S-j"     . org-next-visible-heading        )
              :repeat-map garid/org-repeat
              ("["         . org-previous-visible-heading    )
              ("]"         . org-next-visible-heading        )
              ("u"         . org-up-heading                  )
              ("{"         . org-backward-paragraph          )
              ("}"         . org-forward-paragraph           )
              ("<tab>"     . org-cycle                       )
              ("<backtab>" . org-shifttab                    )
              ("t"         . org-toggle-narrow-to-subtree    )
              ("n"         . org-next-block                  )
              ("p"         . org-previous-block              )
              ("c"         . org-ctrl-c-ctrl-c               )
              :exit
              ("'"         . org-edit-special                ))

  :custom
  ;; ---------------- theme/styling ------------------------------------------------------
  ;; (org-ellipsis                     " â–¼" )
  (org-hide-emphasis-markers         t      )
  (org-image-actual-width            1.0    )
  (org-startup-folded         "show2levels" ) ;; fold
  (org-startup-indented              t      )
  (org-src-fontify-natively          t      )
  (org-startup-with-inline-images    t      )
  (org-startup-with-latex-preview    nil    )
  ;;(org-startup-numerated             t      )
  (org-hide-leading-stars t)
  (org-highlight-latex-and-related    '(latex entities native))

  ;; ---------------- source code in org -------------------------------------------------
  (org-src-tab-acts-natively         t      ) ;; org-src?
  (org-src-preserve-indentation      nil    )
  (org-edit-src-content-indentation  0      )

  ;; ---------------- how to open links in the org mode ----------------------------------
  (org-file-apps '((auto-mode                  . emacs                       )
                   ("\\.html\\'"               . "thorium-browser   \"%s\""  )
                   ("\\.gif\\'"                . "mpv     \"%s\""            )
                   ("\\.mp4\\'"                . "mpv     \"%s\""            )
                   ("\\.png\\'"                . "nsxiv    \"%s\""           )
                   ("\\.svg\\'"                . "inkview \"%s\""            )
                   ("\\.jpeg\\'"               . "nsxiv    \"%s\""           )
                   ("\\.jpg\\'"                . "nsxiv    \"%s\""           )
                   ("\\.pdf\\'"                . "sioyek  \"%s\""            )
                   ("\\.pdf::\\([0-9]+\\)?\\'" . "sioyek  \"%s\" --page %1"  )
                   ("\\.mkv\\'"                . "mpv     \"%s\""            )
                   ("\\.xopp\\'"               . "xournalpp \"%s\""          )))

  ;; ---------------- TODO tabs ----------------------------------------------------------
  (org-todo-keywords      '((sequence "TODO(t)" "NEXT(n)" "WAIT(w)" "PRJT(p)" "VAGUE(v)"
                                      "|"      "NEAR(N)" "DONE(d)" "DONE(d)" "CNCL(c)")))

  (org-todo-keyword-faces '(
                            ("TODO"  . org-todo         )       ;; org-faces?
                            ("PRJT"  . "tomato"         )
                            ("NEXT"  . org-warning      )
                            ("WAIT"  . "gold"           )
                            ("DONE"  . "dim gray"       )
                            ("VAGUE" . "medium purple"  )
                            ("CNCL"  . (:foreground "gray30" :weight bold))))

  (org-log-done            'time)
  (org-tags-column         -100)   ;; how many spaces left padding for tags
  (org-tag-alist           '((:startgroup . nil)
                             ("@rsch" . ?r) ("@bps" . ?w) ("@home" . ?h)
                             (:endgroup . nil)
                             ("phd"  . ?p) ("4bc"   . ?4) ("idea"     . ?i)
                             ("lit"  . ?l) ("yak"   . ?y) ("tool"     . ?T)
                             ("tdbt" . ?t) ("rndm"  . ?R) ("meet"     . ?m)
                             ("qstn" . ??) ("prjt"  . ?P) ("msg/mail" . ?M)
                             ("Life" . ?L) ("write" . ?W) ("errand"   . ?e)
                             ("hkdn" . ?H) ("read" . ?R)
                             ))
  (org-return-follows-link      t) ;; org-keys?

  (org-structure-template-alist
   '(("ba"    . "abstract")
     ("mk"    . "src makefile :tangle no")
     ("sq"    . "sqlite")
     ("py2"   . "src python :session pySess2 :results output :exports both :eval no-export")
     ("py1"   . "src python :session pySess1 :results output :exports both :eval no-export")
     ("py"    . "src python")
     ("do1"   . "src src dot :file (concat org-download-image-dir \"/tmp.svg\") :exports results :eval no-export")
     ("do"    . "src dot")
     ("te"    . "src text")
     ("sh"    . "src sh :eval no-export :shebang \"#!/bin/sh\"")
     ("go1"   . "src go :exports both :eval never-export")
     ("go"    . "src go")
     ("el"    . "src emacs-lisp")
     ("a"     . "export ascii")
     ("c"     . "center")
     ("C"     . "comment")
     ("e"     . "example")
     ("E"     . "export")
     ("h"     . "export html")
     ("l"     . "export latex")
     ("q"     . "quote")
     ("s"     . "src")
     ("sage"  . "src sage")
     ("sage1" . "src sage :session foo :results drawer :exports both :post equation_wrapper_equation_aligned(data=*this*)  :eval never-export")
     ("v"     . "verse")
     ("ju"    . "src jupyter-python :session juSess1 :async yes :eval never-export :exports both")
     ))
  :config
  (require 'org-tempo)
  (plist-put    org-format-latex-options   :scale 1.7      )    ;; latex equation previewing
  (add-to-list 'org-latex-packages-alist   '("" "listings" ))
  (add-to-list 'org-latex-packages-alist   '("" "color"    ))

  (org-babel-do-load-languages
   'org-babel-load-languages '((python     . t) (emacs-lisp . t)
                               (latex      . t) (shell      . t)
                               (dot        . t) (makefile   . t)
                               (sqlite     . t) (gnuplot    . t)
                               (nim        . t) (plantuml   . t)
                               (maxima     . t) (calc       . t)
                               (awk        . t) (go         . t)
                               (asymptote  . t) (ditaa      . t)
                               (nix        . t) (lua        . t)
                               (mermaid    . t) )) ;;(jupyter    . t)

  (font-lock-add-keywords 'org-mode
                          '(("\\(\\(?:\\\\\\(?:label\\|ref\\|eqref\\)\\)\\){\\(.+?\\)}"
                             (1 font-lock-keyword-face)
                             (2 font-lock-constant-face))))
  ;; image backgroud for transparent images
  (defcustom org-inline-image-background nil
    "The color used as the default background for inline images. When nil, use the default face background."
    :group 'org
    :type '(choice color (const nil)))

  (defun create-image-with-background-color (args)
    "Specify background color of Org-mode inline image through modify `ARGS'."
    (let* ((file (car args))
           (type (cadr args))
           (data-p (caddr args))
           (props (cdddr args)))
      ;; Get this return result style from `create-image'.
      (append (list file type data-p)
              (list :background (or org-inline-image-background (face-background 'default)))
              props)))

  (advice-add 'create-image :filter-args
              #'create-image-with-background-color)

  (setq org-inline-image-background "white")

  (evil-define-key 'normal org-mode-map
    (kbd "M-S-<return>") 'org-insert-todo-heading-respect-content)

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;; setting latex preview
  ;;(setq org-preview-latex-default-process 'imagemagick)
  ;;(setf (plist-get (cdr (assq 'imagemagick org-preview-latex-process-alist)) :latex-compiler)
  ;;     '("xelatex -interaction nonstopmode -output-directory %o %f"))
  )
#+end_src
** =org-link=
#+begin_src emacs-lisp
(use-package ol
  :ensure nil
  :after org
  :bind (:map org-mode-map
              :repeat-map garid/org-repeat
              ("N"  . org-next-link     )
              ("P"  . org-previous-link ))
  )
#+end_src
** COMMENT =org-tidy=: hiding the properties
#+begin_src emacs-lisp
(use-package org-tidy
  :ensure t
  :hook   (org-mode . org-tidy-mode))
#+end_src

** =org-indent=
#+begin_src emacs-lisp
(use-package org-indent
  :ensure nil
  :custom
  (org-indent-mode-turns-on-hiding-stars t)
  :delight "")
#+end_src
** =org-num=
#+begin_src emacs-lisp
(use-package org-num
  :ensure nil
  :delight "")
#+end_src
** COMMENT =org-modern=
#+begin_src emacs-lisp
(use-package org-modern
  :after org
  :config
  (global-org-modern-mode 1))
#+end_src
** =org-appear=
#+begin_src emacs-lisp
(use-package org-appear
  :hook (org-mode . org-appear-mode)
  :custom
  (org-appear-autolinks t)
  (org-appear-delay 0.25)
  )
#+end_src

** =org-attach=
#+begin_src emacs-lisp
(use-package org-attach
  :after org
  :ensure nil
  :custom
  ;;(org-id-method                       'org)
  (org-id-method                       'ts)
  (org-attach-id-to-path-function-list '(my/org-attach-dir-calculator
                                         org-attach-id-ts-folder-format
                                         org-attach-id-uuid-folder-format))
  :config
  (defun my/org-attach-dir-calculator (id)
    "id"
    (let ((possible-denote-id (car                     ;; 4. "20241002T190027"
                               (split-string           ;; 3. ("20241002T190027" "denote-getting-id-of-current-file__elisp_org")
                                (file-name-base        ;; 2. "20241002T190027--denote-getting-id-of-current-file__elisp_org.org"
                                 (buffer-file-name))   ;; 1. "/home/garid/BrainDump/denote/20241002T190027--denote-getting-id-of-current-file__elisp_org.org"
                                "--"))))

      (if (length= possible-denote-id 15)
          possible-denote-id
        id)))

  (defun my/org-attach-dir (input-fname)
    (interactive)
    (let ((my-attach-dir
           (concat "data/"
                   (file-name-as-directory
                    (my/org-attach-dir-calculator input-fname)
                    ;; (denote-retrieve-filename-identifier (buffer-file-name)) <= basically same but, not deependent on it
                    ))))
      (unless (file-directory-p my-attach-dir) (mkdir my-attach-dir))
      (concat my-attach-dir input-fname))
    )
  )
#+end_src

** org-babel languages related
#+begin_src emacs-lisp
(use-package plantuml-mode)
(use-package ob-plantuml
  :ensure nil
  :after (org  plantuml-mode)
  :custom
  (org-plantuml-executable-path  "plantuml")
  (org-plantuml-exec-mode        'plantuml))

(use-package ob-nim       :after org)
(use-package ob-go        :after org)
;; (use-package ob-asymptote :after org)


(use-package mermaid-mode)
(use-package ob-mermaid
  :after org
  :custom (ob-mermaid-cli-path "/usr/bin/mmdc"))
#+end_src

* Org zettelkasten notes
** =denote=: Note taking package                                                            :by_prot:
#+begin_src emacs-lisp
(use-package denote
  :ensure t
  :custom
  (denote-excluded-directories-regexp  ".*export_.*\\|.*website.*")
  (denote-directory                    "~/BrainDump/denote")
  (denote-known-keywords               '("phd"  "code"  "python"))
  (denote-templates                    '((biblio . "* Abstract\n\n* Review")
                                         (plain  . nil)))
  (denote-file-type 'org)

  :config
  (when (not (assoc 'python denote-file-types))
    (push '(python :extension ".py"
                   :date-function denote-date-iso-8601
                   :front-matter "# title:      %s\n# date:       %s\n# tags:       %s\n# identifier: %s\n# ---------------------------\n\n"
                   :title-key-regexp "^# title\\s-*:"
                   :title-value-function denote-format-string-for-org-front-matter
                   :title-value-reverse-function denote-trim-whitespace
                   :keywords-key-regexp "^# tags\\s-*:"
                   :keywords-value-function denote-format-keywords-for-text-front-matter
                   :keywords-value-reverse-function denote-extract-keywords-from-front-matter
                   :link denote-org-link-format
                   :link-in-context-regexp denote-org-link-in-context-regexp)
          denote-file-types))

  (defun garid/denote-node-insert-immediate(start end)
    ;; create emtpy denote note on the regions
    (interactive "r")
    (let* ((tmp-str-marked              (string-trim (buffer-substring start end) ))
           (tmp-cur-time-of-this-note  (current-time)))
      (delete-region start end)
      (denote tmp-str-marked '("future") nil "tmp"
              (format-time-string "%Y-%m-%d %H:%M:%S" tmp-cur-time-of-this-note))

      (save-buffer)
      (kill-buffer)

      (insert
       (format
        "[[denote:%s][%s]]"
        (format-time-string "%Y%m%dT%H%M%S" tmp-cur-time-of-this-note)
        tmp-str-marked))))


  )
#+end_src
** =denote-journal= denote journal                                                          :by_prot:
#+begin_src emacs-lisp
(use-package denote-journal
  :custom (denote-journal-extras-title-format 'day))
#+end_src
** =denote-org=                                                                             :by_prot:
#+begin_src emacs-lisp
(use-package denote-org)
#+end_src
** =denote-silo=                                                                            :by_prot:
#+begin_src emacs-lisp
(use-package denote-silo
  :custom
  (denote-silo-directories
   (mapcar
    (lambda (y) (concat "~/BrainDump/" y))
    (seq-filter
     (lambda (x) (string-match "denote.*" x))
     (directory-files "~/BrainDump/")))
   )

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;; (denote-silo-directories            ;;
  ;;  '("~/BrainDump/denote"             ;;
  ;;    "~/BrainDump/denote_bps/"        ;;
  ;;    "~/BrainDump/denote_proj_grape/" ;;
  ;;    "~/BrainDump/marscury/"          ;;
  ;;    ))                               ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  )
#+end_src
** =consult-denote=: consulting with denote                                                 :by_prot:
#+begin_src emacs-lisp
(use-package consult-denote
  :ensure t
  :custom
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;; (consult-denote-silo-source            ;;
  ;;  '("~/BrainDump/denote"                ;;
  ;;    "~/BrainDump/denote_bps/"           ;;
  ;;    "~/BrainDump/denote_proj_grape//")) ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

  (consult-denote-silo-source
   (mapcar
    (lambda (y) (concat "~/BrainDump/" y))
    (seq-filter
     (lambda (x) (string-match "denote.*" x))
     (directory-files "~/BrainDump/")))
   )
  :config
  (consult-denote-mode 1))
#+end_src
** =citar=: citation
#+begin_src emacs-lisp
(use-package citar
  :after org
  :no-require
  :custom
  (org-cite-global-bibliography (list (concat (file-name-as-directory denote-directory)
                                              "20220101T010101--references__study.bib")))
  (org-cite-insert-processor    'citar                        )
  (org-cite-follow-processor    'citar                        )
  (org-cite-activate-processor  'citar                        )
  (citar-bibliography            org-cite-global-bibliography )
  (bibtex-dialect               'biblatex                     )
  (citar-library-paths           (list (concat (file-name-as-directory denote-directory) "lit/")) )
  (citar-file-open-functions '(("html" . citar-file-open-external )
                               ("pdf" . garid/ask-pdf-openner     )
                               (t . find-file                     )))
  :hook
  (org-mode   . citar-capf-setup)
  (LaTeX-mode . citar-capf-setup)
  :config
  (defun garid/ask-pdf-openner (file)
    (interactive)
    (call-process (completing-read "Application" '("sioyek" "okular" "xournalpp")) nil 0 nil file))
  )
#+end_src
** =citar-denote= citation
#+begin_src emacs-lisp
;;(use-package citar-denote
;;  :after (:any citar denote)
;;  :no-require
;;  :delight ""
;;  :custom
;;  ;;(citar-org-roam-subdir                      "g_paper")
;;
;;  ;; Package defaults
;;  (citar-denote-file-type             'org                )
;;  (citar-denote-keyword               "bib"               )
;;  (citar-denote-signature             nil                 )
;;  ;; (citar-denote-subdir              nil                )
;;  (citar-denote-subdir                "lit"               )
;;  ;;(citar-denote-template              'biblio           )
;;  (citar-denote-title-format          "author-year"       )
;;  (citar-denote-title-format-andstr   "and"               )
;;  (citar-denote-title-format-authors  1                   )
;;  (citar-denote-use-bib-keywords      nil                 )
;;
;;  ;; (citar-denote-subdir "")
;;  ;; (citar-denote-template
;;  ;;  (concat "${=key=}\n"
;;  ;;          "#+subtitle: ${=type=}: ${title}\n"
;;  ;;          "#+author:   author(s): ${author}\n"
;;  ;;          "#+filetags: :paper:\n\n"
;;  ;;          "[cite:@${=key=}]\n\n"
;;  ;;          "* Notes\n\n"
;;  ;;          ))
;;  :config
;;  (citar-denote-mode)
;;  :bind (("C-c w d" . citar-denote-dwim                 )
;;         ("C-c w e" . citar-denote-open-reference-entry )
;;         ("C-c w a" . citar-denote-add-citekey          )
;;         ("C-c w k" . citar-denote-remove-citekey       )
;;         ("C-c w r" . citar-denote-find-reference       )
;;         ("C-c w l" . citar-denote-link-reference       )
;;         ("C-c w f" . citar-denote-find-citation        )
;;         ("C-c w x" . citar-denote-nocite               )
;;         ("C-c w y" . citar-denote-cite-nocite          )
;;         ("C-c w z" . citar-denote-nobib                )))

(use-package citar-denote
  :ensure t
  :demand t ;; Ensure minor mode loads
  :after (:any citar denote)
  :custom
  (citar-denote-file-type             'org          )
  (citar-denote-keyword               "bib"         )
  (citar-denote-signature             nil           )
  (citar-denote-subdir                "lit"         )
  (citar-denote-template              nil           )
  (citar-denote-title-format          "author-year" )
  (citar-denote-title-format-andstr   "and"         )
  (citar-denote-title-format-authors  1             )
  (citar-denote-use-bib-keywords      nil           )
  :preface
  (bind-key "C-c w n" #'citar-denote-open-note)
  :init
  (citar-denote-mode)
  ;; Bind all available commands
  :bind (("C-c w d" . citar-denote-dwim)
         ("C-c w e" . citar-denote-open-reference-entry)
         ("C-c w a" . citar-denote-add-citekey)
         ("C-c w k" . citar-denote-remove-citekey)
         ("C-c w r" . citar-denote-find-reference)
         ("C-c w l" . citar-denote-link-reference)
         ("C-c w f" . citar-denote-find-citation)
         ("C-c w x" . citar-denote-nocite)
         ("C-c w y" . citar-denote-cite-nocite)
         ("C-c w z" . citar-denote-nobib)))
#+end_src

** COMMENT =org-roam=
#+begin_src emacs-lisp
(use-package org-roam
  ;; :requires org-roam-dailies ??
  :ensure t
  :custom
  (org-roam-node-display-template (concat "${title:100} "
                                          (propertize "${tags:50}"
                                                      'face 'org-tag)))

  (org-roam-v2-ack                   t                 )
  (org-roam-directory                "~/BrainDump/roam_research")
  (org-roam-db-location              "~/BrainDump/roam_research/0000_database.db")

  (org-roam-completion-everywhere    nil               ) ;;  do I need this?
  (org-roam-dailies-capture-templates
   `(("d" "default" entry "* %<%I:%M %p>: %?"
      :if-new (file+head "g_journal/%<%Y%m%dT%H%M%S>--${slug}.org"
                         ,(concat ":PROPERTIES:\n"
                                  ":ID: %<%Y%m%dT%H%M%S>\n"
                                  ":END:\n"
                                  "#+title: %<%Y-%m-%d>\n"
                                  "#+auto_tangle: nil\n"
                                  "#+startup: show2levels\n"
                                  "#+filetags: :nohtmlexport:\n"
                                  "#+setupfile: ~/.config/emacs/org-templates/level-0-html-export-template.org\n")))
     ))

  (org-roam-capture-templates
   `(("d" "Default" plain "* %?"
      :if-new (file+head "%<%Y%m%dT%H%M%S>--${slug}.org"
                         ,(concat ":PROPERTIES:\n"
                                  ":ID: %<%Y%m%dT%H%M%S>\n"
                                  ":END:\n"
                                  "#+title:    ${title}\n"
                                  "#+filetags: :notag:\n"
                                  "#+date:     %U\n"
                                  "#+setupfile: ~/.config/emacs/org-templates/level-0-html-export-template.org\n"))
      :unnarrowed t)
     ("r" "Research" plain "* %?"
      :if-new (file+head "g_research/%<%Y%m%dT%H%M%S>--${slug}__rsch.org"
                         ,(concat ":PROPERTIES:\n"
                                  ":ID: %<%Y%m%dT%H%M%S>\n"
                                  ":END:\n"
                                  "#+title:    ${title}\n"
                                  "#+filetags: :rsch:\n"
                                  "#+date:     %U\n"
                                  "#+setupfile: ~/.config/emacs/org-templates/level-0-html-export-template.org\n"
                                  ))
      :unnarrowed t)

     ("k" "Kanji" plain "* %?"
      :if-new (file+head "g_kanji/%<%Y%m%dT%H%M%S>--${slug}.org"
                         ,(concat ":PROPERTIES:\n"
                                  ":ID: %<%Y%m%dT%H%M%S>\n"
                                  ":END:\n"
                                  "#+title:     ${title}\n"
                                  "#+filetags: :kanji:\n"
                                  "#+date:      %U\n"
                                  "#+setupfile: ~/.config/emacs/org-templates/level-0-html-export-template.org\n"
                                  ))
      :unnarrowed t)
     ))

  :config
  (org-roam-db-autosync-enable)

  ;; Change the slug (aka filename to be same format as from denote)
  ;; https://github.com/org-roam/org-roam/pull/1544#issuecomment-2211801343
  (cl-defmethod org-roam-node-slug :around ((node org-roam-node))
    (string-replace "_" "-" (cl-call-next-method)))


  (defun garid/org-roam-node-insert-immediate (arg &rest args)
    (interactive "P")
    (let ((args (cons arg args))
          (org-roam-capture-templates
	       (list (append (car org-roam-capture-templates)
		                 '(:immediate-finish t)))))
      (apply #'org-roam-node-insert args)))


  (defun garid/choose-roam-directory ()
    (interactive)
    (setq org-roam-directory
          (completing-read "Choose: "
                           (mapcar
                            (lambda (xx) (f-join "~/BrainDump/" xx)) ;; re-apply root dir
                            (seq-filter
                             (lambda (x) (string-match "roam.*" x))         ;; filter only starting with roam
                             (directory-files "~/BrainDump/")))   ;; list sub dirs
                           ))

    (setq org-roam-db-location
          (f-join org-roam-directory "0000_database.db" ))

    (message "Now org-roam-directory = %s" org-roam-directory)
    (if (string= "yes"
                 (completing-read "Update DB: " '("no" "yes")))
        (org-roam-db-sync)))

  )
#+end_src

** COMMENT =org-roam-ui=: graphing of org-roam in web browser
#+begin_src emacs-lisp
(use-package org-roam-ui :ensure t)
#+end_src

** COMMENT =consult-org-roam=
#+begin_src emacs-lisp
(use-package consult-org-roam
   :ensure t
   :after org-roam
   :delight ""
   :init (require 'consult-org-roam)
   ;; Activate the minor mode
   (consult-org-roam-mode 1)
   :custom
   (consult-org-roam-grep-func #'consult-ripgrep)
   (consult-org-roam-buffer-narrow-key ?r)
   (consult-org-roam-buffer-after-buffers t)
   :config
   ;; Eventually suppress previewing for certain functions
   (consult-customize consult-org-roam-forward-links :preview-key "M-.")
   :bind
   ;; Define some convenient keybindings as an addition
   ("C-c n e" . consult-org-roam-file-find)
   ("C-c n b" . consult-org-roam-backlinks)
   ("C-c n B" . consult-org-roam-backlinks-recursive)
   ("C-c n l" . consult-org-roam-forward-links)
   ("C-c n r" . consult-org-roam-search))
#+end_src

** COMMENT =citar-org-roam=
#+begin_src emacs-lisp
(use-package citar-org-roam
  :after citar org-roam
  :no-require
  :delight "" ; " cor"
  :custom
  (citar-org-roam-subdir                      "g_paper")
  (citar-org-roam-note-title-template (concat "${=key=}\n"
                                              "#+subtitle: ${=type=}: ${title}\n"
                                              "#+author:   author(s): ${author}\n"
                                              "#+filetags: :paper:\n\n"
                                              "[cite:@${=key=}]\n\n"
                                              "* Notes\n\n"
                                              ))
  :config
  (citar-org-roam-mode))

#+end_src

* Org Time managements
** =calendar=
#+begin_src emacs-lisp
(use-package calendar
  :ensure nil
  :custom (calendar-week-start-day 1))
#+end_src
** =org-agenda=: the agenda
#+begin_src emacs-lisp :results none
(use-package org-agenda
  :after    org
  :ensure   nil
  :custom
  (org-agenda-files '("~/BrainDump/denote/20250911T175810--personal__gtd.org"
                      "~/BrainDump/denote_bps/20250911T174108--bps__gtd.org"))
  ;;(org-agenda-span   90)
  (org-agenda-span   3)
  (org-agenda-custom-commands
   '(("i" "Inbox"                tags-todo "+TODO=\"VAGUE\"" ((org-agenda-files (file-expand-wildcards "~/BrainDump/gtd/inbox.org"))))
     ("n" "Next actions"         tags-todo "+TODO=\"TODO\"")
     ("p" "Projects"             tags-todo "+TODO=\"PRJT\"")
     ("w" "Waiting"              tags-todo "+TODO=\"WAIT\"")
     ("s" "Someday"              tags-todo "+TODO=\"TODO\"|TODO=\"PRJT\"" ((org-agenda-files (file-expand-wildcards "~/BrainDump/gtd/someday.org"))))
     ("o" "Actions and Projects" tags-todo "+TODO=\"TODO\"|TODO=\"PRJT\"")))

  (org-agenda-prefix-format '((agenda   . "  %-25:c%?-12t% s" )
                              (timeline . "  % s"             )
                              (todo     . "  %-12:c"          )
                              (tags     . "  %-25:c"          )
                              (search   . "  %-12:c"          )))

  ;;(org-agenda-tags-column -120)
  ;;(org-agenda-tags-column -90)
  (org-agenda-tags-column 'auto)
  (org-agenda-sorting-strategy '((agenda habit-down time-up priority-down category-keep)
                                 (todo priority-down todo-state-up category-keep)
                                 (tags priority-down todo-state-up category-keep)
                                 (search category-keep)))

  ;; M-x org-agenda # to show the stuck projects
  (org-stuck-projects '("+TODO=\"PRJT\"" ("TODO") nil "") )

  (org-refile-use-outline-path             'file)
  (org-outline-path-complete-in-steps      'nil)

  ;; (refile-targets                          (file-expand-wildcards "~/BrainDump/gtd/*.org"))
  (org-refile-targets '( (nil :maxlevel . 6) ;; aka the current file
                         ("~/BrainDump/gtd/main.org"      :maxlevel . 3)
                         ("~/BrainDump/gtd/someday.org"   :level    . 1)
                         ("~/BrainDump/gtd/reference.org" :maxlevel . 1)))


  (org-capture-templates
   '(("i" "Inbox"      entry (file          "~/BrainDump/gtd/inbox.org"           )  "* VAGUE %?\nAdded: %U\n"                                          :empty-lines 1 :prepend t)
     ("I" "Inbox from" entry (file          "~/BrainDump/gtd/inbox.org"           )  "* VAGUE %?\nAdded: %U\nFrom: %a"                                  :empty-lines 1 :prepend t)
     ("n" "Next"       entry (file+headline "~/BrainDump/gtd/main.org"    "Single")  "** NEXT  %?\nAdded: %U\n"                                         :empty-lines 1 :prepend t)
     ("p" "Project"    entry (file+headline "~/BrainDump/gtd/main.org"    "Project")  "* PRJT  %?\n:PROPERTIES:\n:CATEGORY: %^{Id}\n:END:\nAdded: %U\n" :empty-lines 1 :prepend t)
     ("s" "Someday"    entry (file+headline "~/BrainDump/gtd/someday.org" "Someday")  "* TODO  %?\nAdded: %U\n"                                         :empty-lines 1 :prepend t)
     ))

  :config
  ;; (add-hook 'org-agenda-finalize-hook (lambda () (org-agenda-write "/tmp/current-agenda-text")))
  (add-hook 'org-capture-mode-hook 'evil-insert-state)
  )
#+end_src
** =casual-agenda=: casual agenda based on transient
#+begin_src emacs-lisp
(use-package casual-suite
  :ensure t
  :after org-agenda
  :bind (:map org-agenda-mode-map ("<f7>" . casual-agenda-tmenu)
         :map ibuffer-mode-map    ("<f7>" . casual-ibuffer-tmenu)
         :map calc-mode-map       ("<f7>" . casual-calc-tmenu)
         :map dired-mode-map      ("<f7>" . casual-dired-tmenu))
  )
#+end_src
** COMMENT =org-timeblock=: agenda to SVG
#+begin_src emacs-lisp
(use-package org-timeblock
  :after compat-macs)
#+end_src
** =org-caldav=: 
#+begin_src emacs-lisp
(use-package org-caldav
  :custom
  (org-caldav-url          "https://forgetfulfishfunctions.xyz/remote.php/dav/calendars/admin/" )
  (org-caldav-calendar-id  "org-caldav"                                                         )
  ;;(org-caldav-inbox        "~/BrainDump/gtd/main.org"                                         )
  (org-caldav-inbox        "~/BrainDump/denote_bps/20250911T174108--bps__gtd.org"               )
  (org-caldav-files        nil                                                                  )
  (org-icalendar-timezone  "Asia/Tokyo"                                                         )
  )
#+end_src
* Org Exporting related
** =ox=
ref: [[https://emacs.stackexchange.com/a/7989/38482][this answer on emacs-stackexchange]]

#+begin_src emacs-lisp
(use-package ox
  :ensure nil
  :after org
  :config

  ;;(defadvice org-export-output-file-name (before org-add-export-dir activate)
  ;;  "Modifies org-export to place exported files in a different directory"
  ;;  (when (not pub-dir)
  ;;    (setq pub-dir (concat org-export-output-directory-prefix (substring extension 1)))
  ;;    (when (not (file-directory-p pub-dir))
  ;;      (progn
  ;;        (make-directory pub-dir)
  ;;        (make-symbolic-link "../data" (concat (file-name-as-directory pub-dir) "data")))
  ;;      )))

  (defun org-export-output-file-name-modified (orig-fun extension &optional subtreep pub-dir)
    (unless pub-dir
      ;; (setq pub-dir "exported-org-files")
      ;; (defvar org-export-output-directory-prefix "export_" "prefix of directory used for org-mode export")
      ;; (setq pub-dir (concat org-export-output-directory-prefix (substring extension 1)))
      ;; (setq pub-dir (my/org-attach-dir (substring extension 1)))
      (setq pub-dir (concat "export_" (substring extension 1)))
      (unless (file-directory-p pub-dir)
        (make-directory pub-dir)
        (make-symbolic-link "../data" (concat (file-name-as-directory pub-dir) "./data"))
        )
      )
    (apply orig-fun extension subtreep pub-dir nil))
  (advice-add 'org-export-output-file-name :around #'org-export-output-file-name-modified)

  )
#+end_src

** =latex=
#+begin_src emacs-lisp
(use-package latex
  :ensure nil
  ;; :config
  ;;(add-hook 'LaTeX-mode-hook (function (lambda() (set-input-method "TeQ-Math"))))
  ;;(add-hook 'latex-mode-hook (function (lambda() (set-input-method "TeQ-Math"))))
  )
#+end_src

** Latex related
#+begin_src emacs-lisp
(use-package auctex)
(use-package cdlatex)
#+end_src
** =ox-latex=
#+begin_src emacs-lisp
(use-package ox-latex
  :ensure nil
  :after org
  :custom
  (org-latex-src-block-backend              'listings                                             )
  (org-latex-format-headline-function       'garid/latex-formattig-headings                )
  (org-latex-active-timestamp-format         "\\textcolor{Brown}{%s}"                             )
  (org-latex-inactive-timestamp-format       "\\textcolor{Brown}{%s}"                             )
  (org-latex-pdf-process
   '("latexmk -shell-escape -f -xelatex -%latex -interaction=nonstopmode -output-directory=%o %f" ))
  ;; -output-driver=\"xdvipdfmx -z 0\"
  ;;'("latexmk -shell-escape -f -pdf -%latex -interaction=nonstopmode -output-directory=%o %f" ))
  ;; (org-highlight-latex-and-related     '(latex script entities))
  ;; (org-highlight-latex-and-related      nil)
  :config
  (add-to-list 'org-latex-classes '("extarticle" "\\documentclass{extarticle}"
                                    ("\\section{%s}"       . "\\section*{%s}")
                                    ("\\subsection{%s}"    . "\\subsection*{%s}")
                                    ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                                    ("\\paragraph{%s}"     . "\\paragraph*{%s}")
                                    ("\\subparagraph{%s}"  . "\\subparagraph*{%s}")))

  ;; function -------------------------------------------------------------------------------------
  (defun garid/latex-formattig-headings
      (todo todo-type priority text tags _info)
    "Default format function for a headline.
  See `org-latex-format-headline-function' for details."
    (concat
     (and todo
          (format "{\\framebox{\\bfseries\\color{%s} %s}} "
                  (pcase todo-type
                    ('todo "olive") ('done "teal")
                    ;;('todo "Black") ('done "Brown")
                    )
                  todo))
     (and priority (format "\\framebox{\\#%c} " priority)) text
     (and tags
          (format "\\hfill{}\\textsc{%s}"
                  (mapconcat #'org-latex--protect-text tags ":")))))
  )
#+end_src
** =org-latex-preview=
#+begin_src emacs-lisp
(use-package org-latex-preview
  :ensure nil
  :after org-mode
  :hook (org-mode . org-latex-preview-auto-mode)
  :config
  ;; Increase preview width
  (plist-put org-latex-preview-appearance-options
             :page-width 0.8
             )

   ;; Use dvisvgm to generate previews
   ;; You don't need this, it's the default:
   (setq org-latex-preview-process-default 'dvisvgm)

   ;; Block C-n, C-p etc from opening up previews when using auto-mode
   (setq org-latex-preview-auto-ignored-commands
         '(next-line previous-line mwheel-scroll
                     scroll-up-command scroll-down-command))

   ;; Enable consistent equation numbering
   (setq org-latex-preview-numbered t)

   ;; Bonus: Turn on live previews.  This shows you a live preview of a LaTeX
   ;; fragment and updates the preview in real-time as you edit it.
   ;; To preview only environments, set it to '(block edit-special) instead
   (setq org-latex-preview-live t)

   ;; More immediate live-previews -- the default delay is 1 second
   (setq org-latex-preview-live-debounce 0.25)
  )
#+end_src
** =ox-html=
#+begin_src emacs-lisp
(use-package ox-html
  :ensure nil
  :after org
  :custom
  (org-html-validation-link              nil) ;; Don't show validation link
  ;; (org-html-head-include-scripts         nil) ;; Use our own scripts
  ;; (org-html-head-include-default-style   nil) ;; Use our own styles
  ;; (org-html-head "<link rel=\"stylesheet\" type=\"text/css\" href=\"https://orgmode.org/worg/style/worg.css\"/>" )
  )
#+end_src

** =htmlize= - source code syntax in html export
#+begin_src emacs-lisp
(use-package htmlize
  :ensure t
  ;;:config
  ;;(add-hook 'htmlize-before-hook (lambda () (indent-bars-mode -1)))
  )
#+end_src
** =org-re-reveal=
#+begin_src emacs-lisp
(use-package org-re-reveal
  :after org
  :ensure t)
#+end_src

** COMMENT =ox-reveal=
#+begin_src emacs-lisp
(use-package ox-reveal
  :after org
  :ensure t)
#+end_src
* Org Misc:
** =org-download= package itself
#+begin_src emacs-lisp
(use-package org-download
  :ensure t
  :after org
  :custom
  (org-download-display-inline-images  nil)
  (org-download-edit-cmd (concat user-emacs-directory "garid/edit_img.sh %s"))
  (org-download-heading-lvl nil)                                                                            ;;

  :config
  (org-download-enable))
#+end_src

** =org-ipe=
#+begin_src emacs-lisp
(use-package org-ipe
  :straight (org-ipe
             :type git
             :host github
             :brach "master"
             :repo "Stefanomarton/org-ipe"))
#+end_src

** org odt libreoffice-draw
#+begin_src emacs-lisp
(defun garid/odt-edit-open  (path &optional _)
  (interactive)
  (let ((outdir       (file-name-directory      path))
        (path_no_ext  (file-name-sans-extension path)))
    (async-shell-command
     (format "lodraw %s.odg && libreoffice --headless --convert-to %s --outdir %s %s.odg"
             path_no_ext "svg" outdir path_no_ext)
     nil nil)))

(add-to-list 'org-file-apps '("\\ode.svg\\'" . garid/odt-edit-open))
#+end_src

** COMMENT org drawio
#+begin_src emacs-lisp
(defun garid/drawio-edit-open  (path &optional _)
  (interactive)
  (let ((outdir       (file-name-directory      path))
        (path_no_ext  (file-name-sans-extension path)))
    (async-shell-command
     (format
       "drawio %s.drawio  && drawio %s.drawio -x -f svg -o %s.svg --svg-theme light"
       ;;"libreoffice --headless --convert-to %s --outdir %s %s.odg"
      path_no_ext path_no_ext path_no_ext)
     nil nil)
    
    ))

(add-to-list 'org-file-apps '("\\.drawio.svg\\'" . garid/drawio-edit-open))
#+end_src



** =org-auto-tangle=
#+begin_src emacs-lisp
(use-package org-auto-tangle
  :ensure t
  :defer  t
  :after org
  :delight "" ;; " oat"
  :custom (org-auto-tangle-default    nil)
  :hook   (org-mode . org-auto-tangle-mode))
#+end_src

** =org-contacts=
#+begin_src emacs-lisp
(use-package org-contacts
  :ensure t
  :after (org denote)
  :config
  (setq org-contacts-files
        '("~/BrainDump/denote/20240802T185223--contacts__info.org"
          "~/BrainDump/denote_bps/20250306T114521--contacts__info.org"))
  )
#+end_src
* Programming languages
** =prog-mode=
#+begin_src emacs-lisp
(use-package prog-mode
  :ensure nil
  :bind (:map
         prog-mode-map ("M-q" .  nil) ;; I use M-q for delete-window
         )
  ;; :config
  ;; (evil-define-key 'normal 'prog-mode-map  (kbd "K")   'eldoc)      ;; or 'eldoc-box-help-at-point
  )
#+end_src
** =eldoc=
#+begin_src emacs-lisp
(use-package eldoc-box
  :config
  (evil-define-key 'normal 'prog-mode-map  (kbd "K") 'eldoc)
  )
#+end_src
** =python=
#+begin_src emacs-lisp
(use-package python
  :bind (("M-["  . python-nav-backward-defun     )
         ("M-]"  . python-nav-forward-defun      )
         :repeat-map my/python-repeat-map
         ("e"    . python-nav-forward-block      )
         ("a"    . python-nav-backward-block     )
         ("["    . python-nav-backward-defun     )
         ("]"    . python-nav-forward-defun      )
         ("p"    . python-nav-backward-statement )
         ("n"    . python-nav-forward-statement  )
         ("b"    . python-nav-backward-sexp      )
         ("f"    . python-nav-forward-sexp       )
         :map inferior-python-mode-map
         ("C-l" . comint-clear-buffer))
  :hook (inferior-python-mode  . (lambda () (interactive)(setq comint-ptyp nil)))
  :config
  (defun garid/run-pydev-python ()
    ""
    (interactive)
    (run-python "/home/garid/.local/pydev/bin/python"))

  ;;(defun garid/set-python-send-buffer ()
  ;;  ""
  ;;  (interactive)
  ;; must list python buffers
  ;; and interactively set python-shell-buffer-name
  ;;  )
  )
#+end_src
** =code-cells-mode=
#+begin_src emacs-lisp
(use-package code-cells
  :init
  (setq code-cells-boundary-regexp
        "^\\s<+\\(?:\\s-*%\\(?1:%+\\)\\| In\\[[[:space:][:digit:]]*]:\\| \\[\\[\\)")
  :hook (python-base-mode . code-cells-mode)
  :bind (:map code-cells-mode-map
              ("M-<RET>"    . code-cells-eval           )
              ("C-k"        . code-cells-backward-cell  )
              ("C-j"        . code-cells-forward-cell   )
              ("M-k"        . code-cells-move-cell-up   )
              ("M-j"        . code-cells-move-cell-down )
              ("S-<return>" . code-cells-eval-and-step  )
              ("C-<return>" . (lambda () (interactive)
                                (code-cells-forward-cell)
                                (insert "\n# %%\n\n")
                                (previous-line)))
              ("M-v"        . code-cells-mark-cell            )
              ("M-d"        . code-cells-kill                 )
              ("M-D"        . code-cells-duplicate            )
              ("M-;"        . code-cells-comment-or-uncomment )
              ("M-l"        . (lambda () (interactive) (insert "\n# %%\n")))
              )
  )
#+end_src

** =jupyter=
#+begin_src emacs-lisp
(use-package jupyter
  :custom (jupyter-repl-echo-eval-p t))
#+end_src
** =graphviz-dot-mode=
#+begin_src emacs-lisp
(use-package graphviz-dot-mode :ensure t)
#+end_src

** =scad-mode=
#+begin_src emacs-lisp
(use-package scad-mode :ensure t)
#+end_src

** =lua-mode=
#+begin_src emacs-lisp
(use-package lua-mode :ensure t)
#+end_src

** =json-mode=
#+begin_src emacs-lisp
(use-package json-mode :ensure t)
#+end_src

** =elixir= 
#+begin_src emacs-lisp
(use-package elixir-mode)
(use-package ob-elixir)
#+end_src

* Coding input
** =tempel=: snippet system
#+begin_src emacs-lisp
(use-package tempel
  :ensure t
  ;; Require trigger prefix before template name when completing.
  ;; :custom
  ;; (tempel-trigger-prefix "<")
  :bind (("M-8" . tempel-complete) ;; Alternative tempel-expand
         ("M-*" . tempel-insert))

  :init
  (setq tempel-path "~/.config/emacs/tempel/templates.eld")

  ;; Setup completion at point
  (defun tempel-setup-capf ()
    ;; Add the Tempel Capf to `completion-at-point-functions'.
    ;; `tempel-expand' only triggers on exact matches. Alternatively use
    ;; `tempel-complete' if you want to see all matches, but then you
    ;; should also configure `tempel-trigger-prefix', such that Tempel
    ;; does not trigger too often when you don't expect it. NOTE: We add
    ;; `tempel-expand' *before* the main programming mode Capf, such
    ;; that it will be tried first.
    (setq-local completion-at-point-functions
                (cons #'tempel-expand
                      completion-at-point-functions)))

  (add-hook 'conf-mode-hook 'tempel-setup-capf)
  (add-hook 'prog-mode-hook 'tempel-setup-capf)
  (add-hook 'text-mode-hook 'tempel-setup-capf)

  :config
  (defun garid/choose-from-list-and-insert-it (asdf)
    (interactive)
    (insert (let ((choices asdf))
              (completing-read "Choose: " choices))))


  (defun garid/choose-from-list-and-return-it (asdf)
    (interactive)
    (let ((choices asdf))
      (completing-read "Choose: " choices)))
  )
#+end_src

** =elec-pair=: auto parenthesis pair
#+begin_src emacs-lisp
(use-package elec-pair
  :ensure nil
  ;; :custom
  ;; (electric-pair-inhibit-predicate
  ;;  (lambda (c)
  ;;    (if (char-equal c ?\<) t (electric-pair-default-inhibit c))))

  :config
  (electric-pair-mode 1))
#+end_src

* Coding output
** Tree-sitter
from [[https://www.masteringemacs.org/article/how-to-get-started-tree-sitter][mastering emacs article]].
#+begin_src emacs-lisp
(setq major-mode-remap-alist
      '((bash-mode   . bash-ts-mode)
        (python-mode . python-ts-mode)))

(setf (alist-get "python" org-src-lang-modes nil nil #'equal) 'python-ts)
#+end_src
** COMMENT =indent-bars=
#+begin_src emacs-lisp
(use-package indent-bars
  ;;:load-path "~/code/emacs/indent-bars"
  :ensure t
  :straight (indent-bars :type git :host github :repo "jdtsmith/indent-bars")
  :custom
  (indent-bars-treesit-support   t)
  (indent-bars-no-descend-string nil)
  (indent-bars-prefer-character  "|")
  (indent-bars-treesit-ignore-blank-lines-types '("module"))
  (indent-bars-treesit-wrap '((python argument_list parameters ; for python, as an example
				      list list_comprehension
				      dictionary dictionary_comprehension
				      parenthesized_expression subscript)))
  ;;:hook ((python-base-mode yaml-mode) . indent-bars-mode)
  ;;:hook ((python-base-mode yaml-mode) . indent-bars--ts-mode)
  )
#+end_src
* Coding lsp & jumping around
** =eglot=: lsp
#+begin_src emacs-lisp
(use-package eglot
  ;;:custom (eglot-report-progress nil)   ;
  ;; :custom (eglot-report-progress t)   ;
  ;; ;;:config (add-to-list 'eglot-server-programs '(nix-ts-mode . ("nil")))
  :hook
  (python-base-mode . eglot-ensure)
  ;; :config
  ;; ;; (add-to-list 'eglot-stay-out-of 'eldoc)
  ;; (add-to-list 'eglot-server-programs
  ;;              '(python-mode . ("pyright")))

  :config
  ;; (add-to-list 'eglot-stay-out-of 'eldoc)
  (add-to-list 'eglot-server-programs
               '(python-mode . ("pyright-langserver" "--stdio")))

  (add-to-list 'eglot-server-programs
               '(org-mode . ("harper-ls" "--stdio")))

  ;;'(python-mode . ("basedpyright"))) ;; not working not sure why
  (evil-define-key 'normal 'prog-mode-map  (kbd "g o") 'eglot-find-typeDefinition)
  (evil-define-key 'normal 'prog-mode-map  (kbd "] d") 'flymake-goto-next-error)
  (evil-define-key 'normal 'prog-mode-map  (kbd "[ d") 'flymake-goto-prev-error)

  (add-hook
   'eglot-managed-mode-hook
   (lambda ()
     ;; we want eglot to setup callbacks from eldoc, but we don't want eldoc
     ;; running after every command. As a workaround, we disable it after we just
     ;; enabled it. Now calling `M-x eldoc` will put the help we want in the eldoc
     ;; buffer. Alternatively we could tell eglot to stay out of eldoc, and add
     ;; the hooks manually, but that seems fragile to updates in eglot.
     (eldoc-mode -1)))

  )
;;"--flag=value"))))
#+end_src
** =consult-eglot=: consulting with lsp
#+begin_src emacs-lisp
(use-package consult-eglot :ensure t)
#+end_src
** =eglot-booster=: faster eglot
#+begin_src emacs-lisp
(use-package eglot-booster
  :ensure t
  :straight (eglot-booster
             :type git
             :host github
             :repo "jdtsmith/eglot-booster")
  :config
  (eglot-booster-mode +1)
  )
#+end_src

** =corfu=: completion
#+begin_src emacs-lisp
(use-package corfu
  ;; Optional customizations
  :ensure t
  :custom
  (corfu-cycle            t          ) ;; Allows cycling through candidates
  (corfu-auto             t          ) ;; Enable auto completion nov23 C-M-i?
  (corfu-auto-prefix      2          )
  (corfu-auto-delay       0.1        )
  (corfu-popupinfo-delay '(0.8 . 0.2))
  (corfu-preview-current   nil       )
  (corfu-on-exact-match    nil       ) ;; Don't auto expand tempel snippets

  ;; Optionally use TAB for cycling, default is `corfu-complete'.
  :bind (:map corfu-map
              ("M-SPC"      . corfu-insert-separator )
              ;;("TAB"        . corfu-insert           )
              ;;([tab]        . corfu-insert           )
              ("S-<return>" . corfu-insert           )
              ("M-h"        . corfu-insert           )
              ("RET"        . nil                    ))

  :init
  (setq tab-always-indent 'complete)
  ;;:config
  (global-corfu-mode    )
  (corfu-history-mode   )
  (corfu-popupinfo-mode )

  :hook
  (eshell-mode-hook . (lambda () (setq-local corfu-quit-at-boundary t
        			             corfu-quit-no-match t
        			             corfu-auto nil)
                        (corfu-mode)))
  )
#+end_src
** =cape=: completion at point extensions
#+begin_src emacs-lisp
(use-package cape
  ;; Bind prefix keymap providing all Cape commands under a mnemonic key.
  ;; Press C-c p ? to for help.
  :ensure t
  :bind ("C-c p" . cape-prefix-map) ;; Alternative keys: M-p, M-+, ...
  ;; Alternatively bind Cape commands individually.
  ;; :bind (("C-c p d" . cape-dabbrev)
  ;;        ("C-c p h" . cape-history)
  ;;        ("C-c p f" . cape-file)
  ;;        ...)
  :init
  ;; Add to the global default value of `completion-at-point-functions' which is
  ;; used by `completion-at-point'.  The order of the functions matters, the
  ;; first function returning a result wins.  Note that the list of buffer-local
  ;; completion functions takes precedence over the global list.
  (add-hook 'completion-at-point-functions #'cape-dabbrev)
  (add-hook 'completion-at-point-functions #'cape-file)
  ;; (add-hook 'completion-at-point-functions #'cape-elisp-block)
  (add-hook 'completion-at-point-functions #'cape-history)
)
#+end_src

** =abbrev=
#+begin_src emacs-lisp
(use-package abbrev
  :delight "" ;;" abb"
  :defer 1
  :ensure nil
  ;;:custom
  ;;(abbrev-file-name (expand-file-name "abbrev_defs" user-emacs-directory))
  :config
  (if (file-exists-p abbrev-file-name)
      (quietly-read-abbrev-file))

  ;;(abbrev-mode 1)
  (setq-default abbrev-mode t)
  )
#+end_src

** =gptel= : gpt.el by karthinks 
#+begin_src emacs-lisp
(use-package gptel
  :custom
  (gptel-default-mode 'org-mode)
  )
#+end_src

* Coding convenient
** =rg=: ripgrep in Emacs
Probably requires external =rg= command.

#+begin_src emacs-lisp
(use-package rg
  :ensure t)
#+end_src

** =magit=: git control
#+begin_src emacs-lisp
(use-package magit
  :ensure t)
#+end_src

** =git-gutter=: git diff shows on the side
Similar to vim-signify.
#+begin_src emacs-lisp
(use-package git-gutter
  :delight  " git"
  :ensure t
  :bind (:repeat-map git-gutter:repeat-map
                     ("n" . git-gutter:next-hunk)
                     ("p" . git-gutter:previous-hunk)
                     ("s" . git-gutter:stage-hunk)
                     ("r" . git-gutter:revert-hunk)
                     :exit ;; here are available in the repeat, but only once executed
                     ("c" . magit-commit-create)
                     ("C" . magit-commit)
                     ("b" . magit-blame)
                     )
  :config (global-git-gutter-mode)
  )
#+end_src

** =harpoon=
#+begin_src emacs-lisp
(use-package harpoon
  :ensure t
  :bind
  ("M-1"   .  harpoon-go-to-1           )
  ("M-2"   .  harpoon-go-to-2           )
  ("M-3"   .  harpoon-go-to-3           )
  ("M-4"   .  harpoon-go-to-4           )
  ("M-5"   .  harpoon-go-to-5           )
  ("M-6"   .  harpoon-go-to-6           )
  ("<f9>"  .  harpoon-quick-menu-hydra  )
  )
#+end_src

** =project.el=
#+begin_src emacs-lisp
(use-package project
  :ensure nil
  :custom
  (project-switch-commands
   '(
     (project-find-file    "Find file"      )
     (project-find-regexp  "Find regexp"    )
     (project-find-dir     "Find directory" )
     (magit-project-status "Magit"          )
     (project-eshell       "Eshell"         )
     (project-any-command  "Other"          ))
   )

  :config
  (keymap-set project-prefix-map "m" #'magit-project-status)
  )
#+end_src

** =direnv.el=
#+begin_src emacs-lisp
(use-package direnv
 :config
 (direnv-mode))
#+end_src

* Bunch of functions
** Open PDF/HMTL exported by LaTeX externally                                          :customFunc:
#+begin_src emacs-lisp
(defun replace-in-string (what with in)
  (replace-regexp-in-string (regexp-quote what) with in nil 'literal))

(defun garid/org-open-pdf ()
  (interactive)
  (call-process-shell-command
   (concat "xdg-open "                                  ;; try to open default PDF viewer
           (file-name-directory buffer-file-name)       ;; directory of current file/buffer
           "/export_tex/"                               ;; adds export directory name
           (file-name-base)                             ;; filaname (of current file/buffer) without extension
           ".pdf &"                                     ;; adds extension
           )))

(defun garid/org-open-html ()
  (interactive)
  (call-process-shell-command
   (concat "$BROWSER "                                  ;; try to open default PDF viewer
           (file-name-directory buffer-file-name)    ;; directory of current file/buffer
           "/export_html/"                           ;; adds export directory name
           (file-name-base)                          ;; filaname (of current file/buffer) without extension
           ".html &"                                 ;; adds extension

           ;; (file-name-directory buffer-file-name)
           ;; (my/org-attach-dir "")
           ;; (file-name-base)
           ;; ".html &"                                 ;; adds extension
           )))
#+end_src

** My Custom LaTeX writing system (aka TeQ)                                            :customFunc:
#+begin_src emacs-lisp
(add-to-list 'load-path (expand-file-name "~/.config/emacs/Emacs-TeQ"))
(register-input-method "TeQ-Math" "Emacs-Teq-Latex" 'quail-use-package
                       "TeQ-"     "TeQ-Math input"
                       "Emacs-TeQ.el")

(defun garid/toggle-eng-mon-teq-input-methods ()
  (interactive)
  (if (string= default-input-method nil )
      (set-input-method "cyrillic-mongolian")
    (if (string= default-input-method "TeQ-Math")
	(set-input-method "cyrillic-mongolian")
      (if (string= default-input-method "cyrillic-mongolian")
	  (set-input-method "TeQ-Math")))))

(fset 'gry-calc-horizontal-concat
      (kmacro-lambda-form [?v ?t tab ?v ?t ?| ?v ?t] 0 "%d"))
#+end_src

** COMMENT Custom Aligner function (with untabify)                                     :customFunc:
#+begin_src emacs-lisp
(defun garid/align-regexp-and-untabify (beg end)
  (interactive "r")
  (align-regexp beg end
                (concat "\\(\\s-*\\)" (read-string "Align regexp: ")))
  (untabify beg end))
#+end_src
** copy link in org at point                                                           :customFunc:
[[https://emacs.stackexchange.com/a/60555/38482][stack exchange]]

#+begin_src emacs-lisp
(defun garid/open-org-link-at-point-with-dired (&optional arg)
  "Extract URL from org-mode link and add it to kill ring." ;;;
  (interactive "P")
  (let* ((link (org-element-lineage (org-element-context) '(link) t))
         (type (org-element-property :type link))
         (url (org-element-property  :path link)))
    (message (concat "Copied URL: " url))
    (dired-jump t (file-name-directory url))))
#+end_src
** Jumping ref-label in org or latex                                                   :customFunc:
#+begin_src emacs-lisp
(defun garid/jump-label-def-of-ref-at-point-word ()
  ""
  (interactive)
  ;; jump to closing } part of:  \ref{...}
  (progn
    (search-forward "}")
    (backward-char 1))

  ;; copy and consult-line with thing inside of {} parenthesis of \ref{...}
  (let ((start (search-backward "{" nil t))
        (end (search-forward "}" nil t)))
    (if (and start end)
        (let ((content (buffer-substring-no-properties (1+ start) (1- end))))
          (consult-line (format "\\label{%s}" content))
          )
      (message "No matching braces found."))))
#+end_src
** Org toggle hide/shot hyperlink                                                      :customFunc:
#+begin_src emacs-lisp
(defun garid/org-toggle-link-n-emphasis ()
  (interactive)
  (setq org-hide-emphasis-markers (not org-hide-emphasis-markers))
  (setq org-link-descriptive           org-hide-emphasis-markers) ;;(org-toggle-link-display) more in below
  ;;(org-link-descriptive-ensure) ;; strange isseu need to check later
  (org-restart-font-lock)
  (font-lock-update))
#+end_src

** Custom opening external terminal at current buffer                                  :customFunc:
#+begin_src emacs-lisp
(defun garid/open-external-term-here ()
  (interactive)
  (call-process-shell-command
   (concat
    user-emacs-directory "garid/open_external_term.sh" " " buffer-file-name)))
;;(shell-command (concat user-emacs-directory "garid/open_external_term.sh" " " buffer-file-name)))
#+end_src

** Org toggle hide/shot display images                                                 :customFunc:
#+begin_src emacs-lisp
(defun garid/org-toggle-display-images-n-edraw ()
  (interactive)
  (org-toggle-inline-images)
  (if org-inline-image-overlays
      (edraw-org-link-image-mode +1)
    (edraw-org-link-image-mode -1)
    ))
#+end_src

** Org structure in the denote dire                                                    :customFunc:
#+begin_src emacs-lisp
(defun garid/org-ql-function-on-each-heading (INCLUDE_PROGRESS)
  ""
  (format "%s_ %s %s"
          (make-string (+ 1 (nth 0 (org-heading-components)) ) ?*) ;; recreate the *
          (nth 4 (org-heading-components))
          (if (and INCLUDE_PROGRESS (seq-find
                                     (lambda (elt) (string= "PROGRESS" (car elt) ))
                                     (org-entry-properties)))
              (let ((tmp-progress (string-to-number
                                   (cdr (car (seq-filter (lambda (elt) (string= "PROGRESS" (car elt) )) (org-entry-properties)))))
                                  ))

                ;;(format "<font:monospaced>[<back:black>â˜â˜â˜â˜â˜</back><back:lightgray>â˜â˜â˜â˜â˜</back> 10%]</font>")
                (format "\\n<font:monospaced>[<back:black>%s</back><back:lightgray>%s</back> %d%s]</font>"
                        (make-string (/ tmp-progress 10) ?â˜)
                        (make-string (- 10 (/ tmp-progress 10) ) ?â˜)
                        tmp-progress
                        "%"
                        ))
            "")
          ))

(defun garid/org-ql-plantuml-body-prepper-on-current-buffer ()
  (concat
   ;;"@startwbs\n"
   "@startmindmap\n"
   "* Thesis"
   "\n"
   (mapconcat 'identity
              (org-ql-select
                (current-buffer) ;; BUFFERS-OR-FILES, i.e. Can be path of file
                '(level 1 3) ;; QUERY 1-to-3 inclusive
                ;;:action 'garid/org-ql-function-on-each-heading
                :action (lambda ()
                          (garid/org-ql-function-on-each-heading t)
                          ))
              "\n")
   ;;"\n@endwbs\n"
   "\n@endmindmap\n"
   ))

;;(garid/org-ql-plantuml-body-prepper-on-current-buffer)
(defun garid/create-plantuml-using-temp-file (outFname)
  ""
  (let ((tmp-basename (concat "/tmp/" (file-name-base outFname) ".puml"))
        (tmp-extension (file-name-extension outFname))
        (tmp-outputdir (concat (file-name-directory buffer-file-name) (my/org-attach-dir "")))
        )

    (f-write (garid/org-ql-plantuml-body-prepper-on-current-buffer)
             'utf-8
             tmp-basename)

    (message (format "plantuml %s %s -o %s "
                     (concat "-t" tmp-extension)
                     tmp-basename
                     tmp-outputdir))

    (call-process-shell-command (format "plantuml %s %s -o %s "
                                        (concat "-t" tmp-extension)
                                        tmp-basename
                                        tmp-outputdir
                                        ));;outDir

    (my/org-attach-dir outFname)
    ))
#+end_src

** Remove equal sign from both sides in string                                         :customFunc:
#+begin_src emacs-lisp
(defun remove-equal-from-both-sides (str)
  "Remove the tilde (~) character from the beginning and end of STR."
  (if (string-match "\\`=\\(.*?\\)=\\'" str)  ;;
      ;; \\`~ front
      ;; \\(.*?\\) capture group
      ;; ~\\'  end?
      (match-string 1 str)
    str))
#+end_src

** Kill ring and garbage collect                                                       :customFunc:
#+begin_src emacs-lisp
(defun garid/clear-kill-ring-and-garbage-collect ()
  (interactive)
  (setq kill-ring nil)
  (garbage-collect))
#+end_src

* Writing & Reading
** ispell config
#+begin_src emacs-lisp
(use-package ispell
  :ensure t
  :custom (ispell-alternate-dictionary "/home/garid/.config/emacs/ispell-wl.txt"))
#+end_src
** Writing packages
#+begin_src emacs-lisp
;; (use-package selectric-mode       :ensure t)
;; (use-package typewriter-roll-mode :ensure t)
(use-package darkroom             :ensure t)
(use-package focus                :ensure t)
#+end_src

** =pdf-tools=: reading pdf in Emacs
#+begin_src emacs-lisp
(use-package pdf-tools
  :ensure t
  :bind (:map pdf-view-mode-map
              ("t" . pdf-outline))
  :mode  ("\\.pdf\\'" . pdf-view-mode)
  :config
  (pdf-tools-install))
#+end_src

** =edraw= svg drawing inline in org
#+begin_src emacs-lisp
(use-package edraw-mode
  :straight (edraw-mode
             :type git
             :host github
             :brach "master"
             :repo "misohena/el-easydraw")


  :after (org ox ox-latex ox-html)
  ;; :hook (edraw-property-editor-mode . turn-off-evil-mode) test
  :custom
  (edraw-editor-default-grid-interval 10)
  (edraw-default-shape-properties '((rect (fill            . #1="#f8f8f8")
                                          (stroke          . #2="#101010")
                                          (stroke-width    . 2))
                                    (ellipse (fill         . #1#)
                                             (stroke       . #2#)
                                             (stroke-width . 2))
                                    (path (fill            . "none")
                                          (stroke          . #2#)
                                          (stroke-width    . 2) ;;(marker-end . "arrow")   p > or p <
                                          )
                                    (text (fill            . #2#)
                                          ;; (font-size       . 20)
                                          (font-size       . 24)
                                          ;;(font-family     . "sans-serif")
                                          ;; (font-family     . "Linux Libertine")
                                          ;;(font-family     . "xkcd Script")
                                          (text-anchor     . "middle"))
                                    (image)))
  (edraw-default-document-properties '((width .  900)
                                       (height . 400)
                                       (background . "#fff")))
  :config
  ;;(edraw-org-setup-default)
  ;;(edraw-org-setup-exporter)

  (with-eval-after-load 'org
    (require 'edraw-org)
    (edraw-org-setup-default)
    )
  ;; When using the org-export-in-background option (when using the
  ;; asynchronous export function), the following settings are
  ;; required. This is because Emacs started in a separate process does
  ;; not load org.el but only ox.el.
  (with-eval-after-load "ox"
    (require 'edraw-org)
    (edraw-org-setup-exporter))

  )
#+end_src
** =captain=
#+begin_src emacs-lisp
(use-package captain
  :delight "" ;; " cap"
  :after org
  :custom
  (sentence-end-double-space nil)

  :config ;; from https://emacs.stackexchange.com/q/54326/38482
  ;; don't capitalize in programming modes.
  (add-hook 'prog-mode-hook
            (lambda ()
              (setq captain-predicate
                    (lambda () (nth 8 (syntax-ppss (point)))))))
  ;; Or for text modes, work all the time:
  (add-hook 'text-mode-hook
            (lambda ()
              (setq captain-predicate (lambda () t))))

  ;; Or don't work in source blocks in Org-mode:
  (add-hook 'org-mode-hook
            (lambda ()
              (setq captain-predicate
                    (lambda () (not (org-in-src-block-p))))))


  (add-hook 'latex-mode-hook (lambda () (captain-mode -1)))
  (global-captain-mode t)
  )
#+end_src

** COMMENT Writing Distraction free                                                    :customFunc:
#+begin_src emacs-lisp
(defun garid/distraction-free-on ()
  (interactive)
  ;;(turn-off-evil-mode)
  (global-set-key (kbd "M-f") 'forward-word)
  (evil-mode -1)
  (darkroom-mode             +1)
  (typewriter-roll-mode      +1)
  (display-line-numbers-mode  -1)
  (which-key-mode             -1)
  (focus-mode                 +1)

  (cond
   ((member "Iosevka Aile"      (font-family-list)) (set-face-attribute 'default nil :font "Iosevka Aile"      :height 120))
   ((member "Libre Baskerville" (font-family-list)) (set-face-attribute 'default nil :font "Libre Baskerville" :height 120))
   ((member "Liberation Sans"   (font-family-list)) (set-face-attribute 'default nil :font "Liberation Sans"   :height 120))
   ((member "Courier New"       (font-family-list)) (set-face-attribute 'default nil :font "Courier New"       :height 140))
   ))

(defun garid/distraction-free-off ()
  (interactive)

  (global-set-key (kbd "M-f") 'consult-line)
  (darkroom-mode         -1)
  (evil-mode +1)
  (typewriter-roll-mode  -1)
  (global-corfu-mode     +1)
  (which-key-mode        +1)
  (focus-mode            -1)

  (cond
   ((member "Iosevka Term SS06" (font-family-list)) (set-face-attribute 'default nil :font "Iosevka Term SS06" :height 120))
   ((member "Iosevka"           (font-family-list)) (set-face-attribute 'default nil :font "Iosevka"           :height 150))
   ))

(setq gry-toggle-distraction-free-writing-state t)

(defun garid/toggle-distraction-free-writing ()
  (interactive)
  (setq gry-toggle-distraction-free-writing-state
        (not gry-toggle-distraction-free-writing-state))
  (if gry-toggle-distraction-free-writing-state
      (garid/distraction-free-on)
    (garid/distraction-free-off)))
#+end_src

#+RESULTS:
: garid/toggle-distraction-free-writing

** COMMENT =tmr=: timer may ring
#+begin_src emacs-lisp
(use-package tmr :ensure t)
#+end_src
** COMMENT checking (could be useful)
#+begin_src emacs-lisp
;; (use-package langtool   :ensure t) it required external jar / java  someday i will try
(use-package jinx          :ensure t)
(use-package mw-thesaurus  :ensure t :after org)
;;(use-package org-wc        :ensure t :after org)
#+end_src

* Keybinding
** =which-key=: keybinding shower
#+begin_src emacs-lisp
(use-package which-key
  :delight
  :ensure t
  :custom
  (which-key-popup-type              'side-window             )
  (which-key-side-window-location    'right                   )
  ;;(which-key-side-window-max-width    0.5                     )
  ;;(which-key-popup-type              'minibuffer              )
  (which-key-idle-delay               0.8                       )
  (which-key-idle-secondary-delay     0.01                      )
  (which-key-sort-order              'which-key-key-order-alpha )
  :config (which-key-mode))
#+end_src

** Non sequential keybindings
*** Global keybinding table
#+caption: Global (aka from anywhere) non-sequential keybinding
#+name: tbl-global-keybindings
| key     | function                               | description                       | state                 |
|---------+----------------------------------------+-----------------------------------+-----------------------|
| =M-q=     | =delete-window=                          | delete window                     | =evil-normal-state-map= |
| =M-Q=     | =kill-current-buffer=                    | delete buffer                     | =evil-normal-state-map= |
| =C-/=     | =comment-line=                           | set selected lines comment        | =evil-normal-state-map= |
| =C-\vert= | =garid/toggle-eng-mon-teq-input-methods= | change toggle input (Eng-Mon-Teq) | =evil-normal-state-map= |
| =M-<f9>=  | =garid/toggle-distraction-free-writing=  | toggle distraction free writing   | =evil-normal-state-map= |
#+TBLFM: 

Note to myself: after changing Table-[[tbl-global-keybindings]], I need to update [[convert-global-keybindings]]

*** Convert global keybinding table into elisp
#+caption: adsf
#+name: convert-global-keybindings
#+begin_src elisp :var tab=tbl-global-keybindings :wrap src emacs-lisp :tangle no
(concat
 (mapconcat
  (lambda (row)
    (format
     "(global-set-key (kbd \"%s\") '%s)"
     ;; needed to use regexp cuz | (as \vert) used in the table
     (replace-regexp-in-string (regexp-quote "\\vert") "|"
                               (remove-equal-from-both-sides (nth 0 row))
                               nil 'literal)
     (remove-equal-from-both-sides (nth 1 row))
     ;;(nth 1 row)
     ))
  tab "\n"))
#+end_src
*** The result
#+RESULTS: convert-global-keybindings
#+begin_src emacs-lisp
(global-set-key (kbd "M-q") 'delete-window)
(global-set-key (kbd "M-Q") 'kill-current-buffer)
(global-set-key (kbd "C-/") 'comment-line)
(global-set-key (kbd "C-|") 'garid/toggle-eng-mon-teq-input-methods)
(global-set-key (kbd "M-<f9>") 'garid/toggle-distraction-free-writing)
#+end_src
** Sequential keybindings (General.el keybinding configuration)
*** Sequential global keybindings
**** File and directory surfing
#+attr_latex: :placement [H]
#+caption: File and directory related commands
#+name: tbl-kbinding-file-n-dired
| key(s) | function                                                                    | short description   | mode | lambda |
|--------+-----------------------------------------------------------------------------+---------------------+------+--------|
| =SPC=    | =execute-extended-command=                                                    | M-x                 | -    |        |
| =f=      | =(if (project-current) (project-find-file) (call-interactively #'find-file))= | find-file           | -    | y      |
| =d=      | =dired-jump=                                                                  | directory           | -    |        |
| =D=      | =:ignore t=                                                                   | Dired.............. | -    |        |
| =Ds=     | =dired=                                                                       | simple              | -    |        |
| =Dp=     | =dired-preview-mode=                                                          | preview             | -    |        |
| =Dw=     | =wdired-change-to-wdired-mode=                                                | wdired              | -    |        |

**** Buffer and operations on buffer
#+attr_latex: :placement [H]
#+caption: buffer related commands
#+name: tbl-kbind-buffer-related
| key(s) | function                    | short description           | mode | lambda |
|--------+-----------------------------+-----------------------------+------+--------|
| =l=      | =consult-buffer=              | list-buffer                 | -    |        |
| =L=      | =:ignore t=                   | buffer..................... | -    |        |
| =Lr=     | =revert-buffer-quick=         | revert (reload)             | -    |        |
| =Le=     | =eval-buffer=                 | evaluate buffer             | -    |        |
| =Li=     | =ibuffer=                     | ibuffer                     | -    |        |
| =Ln=     | =rename-buffer=               | rename                      | -    |        |
| =L<=     | =switch-to-prev-buffer=       | <prev                       | -    |        |
| =L>=     | =switch-to-next-buffer=       | >next                       | -    |        |
| =Ld=     | =crux-delete-file-and-buffer= | delete                      | -    |        |
| =Lc=     | =clone-indirect-buffer=       | clone                       | -    |        |
| =Ls=     | =crux-create-scratch-buffer=  | scratch-buffer              | -    |        |
| =Lh=     | =buf-move-left=               | move left                   | -    |        |
| =Lj=     | =buf-move-down=               | move down                   | -    |        |
| =Lk=     | =buf-move-up=                 | move up                     | -    |        |
| =Ll=     | =buf-move-right=              | move right                  | -    |        |
| =LL=     | =tear-off-window=             | tear window to frame        | -    |        |

**** Convenient
#+attr_latex: :placement [H]
#+caption: Convenient commands
#+name: tbl-kbind-zconvenients
| key(s) | function                          | short description                 | mode | lambda |
|--------+-----------------------------------+-----------------------------------+------+--------|
| =z=      | =:ignore t=                         | conveniences....................  | -    |        |
| =za=     | =align-regexp=                      | align                             | -    |        |
| =zr=     | =replace-regexp=                    | replace                           | -    |        |
| =zh=     | =highlight-symbol-at-point=         | highlight-on                      | -    |        |
| =zH=     | =unhighlight-regexp=                | highlight-off                     | -    |        |
|--------+-----------------------------------+-----------------------------------+------+--------|
| =zs=     | =:ignore t=                         | spell............................ | -    |        |
| =zsw=    | =ispell-word=                       | word                              | -    |        |
| =zsr=    | =ispell-region=                     | region                            | -    |        |
| =zsC=    | =ispell-comments-and-strings=       | comment-full                      | -    |        |
| =zsc=    | =ispell-comment-or-string-at-point= | comment-here                      | -    |        |
| =zsb=    | =ispell-buffer=                     | buffer                            | -    |        |
| =zsm=    | =ispell-message=                    | message                           | -    |        |
| =zsq=    | =ispell-kill-ispell=                | quit                              | -    |        |
| =zsl=    | =ispell-change-dictionary=          | language en/mn                    | -    |        |
| =zst=    | =mw-thesaurus-lookup-at-point=      | thesaurus current word            | -    |        |
| =zsT=    | =mw-thesaurus-lookup=               | thesaurus                         | -    |        |
|--------+-----------------------------------+-----------------------------------+------+--------|
| =ZQ=     | =kill-emacs=                        | kill Emacs                        | -    |        |



Older
| =za=     | =garid/align-regexp-and-untabify=   | align                             | -    |        |

**** System
#+attr_latex: :placement [H]
#+caption: system commmands
#+name: tbl-kbind-sys-related
| key(s) | function                                                                                   | short description             | mode | lambda |
|--------+--------------------------------------------------------------------------------------------+-------------------------------+------+--------|
| =s=      | =:ignore t=                                                                                  | system....................... | -    |        |
| =srf=    | =consult-recent-file=                                                                      | recent-f.iles                 | -    |        |
|--------+--------------------------------------------------------------------------------------------+-------------------------------+------+--------|
| =sl=     | =:ignore t=                                                                                  | line......................... | -    |        |
| =slm=    | =scroll-lock-mode=                                                                           | scroll-lock-mode              | -    |        |
| =slv=    | =global-display-fill-column-indicator-mode=                                                  | vertical-line                 | -    |        |
| =sln=    | =display-line-numbers-mode=                                                                  | number toggle                 | -    |        |
| =slr=    | =ruler-mode=                                                                                 | ruler mode                    | -    |        |
| =scl=    | =(global-command-log-mode) (clm/open-command-log-buffer)=                                    | command log mode              | -    | y      |
| =sw=     | =whitespace-mode=                                                                            | whitespace                    | -    |        |
| =sg=     | =:ignore t=                                                                                  | garid                         | -    |        |
| =sgf=    | =garid/distraction-free-on=                                                                  | focus                         | -    |        |
| =sgr=    | =garid/distraction-free-off=                                                                 | reset                         | -    |        |
|--------+--------------------------------------------------------------------------------------------+-------------------------------+------+--------|
| =O=      | =:ignore t=                                                                                  | open........................  | -    |        |
| =Oe=     | =(find-file "~/.config/emacs/init.org")=                                                     | emacs init.org                | -    | y      |
| =OE=     | =(find-file "~/.config/emacs/init.el")=                                                      | emacs init.el                 | -    | y      |
| =Ob=     | =(find-file (nth 0 org-cite-global-bibliography))=                                           | bibliography                  | -    | y      |
| =Op=     | =(find-file "~/BrainDump/bookshelf/")=                                                       | pdf                           | -    | y      |
| =Oc=     | =citar-open=                                                                                 | citaiton                      | -    |        |
| =OO=     | =(find-file org-default-notes-file)=                                                         | org capture                   | -    | y      |
| =Oi=     | =(find-file "~/BrainDump/gtd/inbox.org")=                                                    | inbox                         | -    | y      |
| =Om=     | =(find-file "~/BrainDump/gtd/main.org")=                                                     | main                          | -    | y      |
| =Or=     | =(find-file (concat denote-directory "/phd/20240814T113502--00-garids-phd-index__phd.org"))= | research index                | -    | y      |
|--------+--------------------------------------------------------------------------------------------+-------------------------------+------+--------|
| =t=      | =:ignore t=                                                                                  | terminal..................... | -    |        |
| =te=     | =eshell=                                                                                     | eshell emacs-shell            | -    |        |
| =tv=     | =vterm=                                                                                      | vterm  vterm                  | -    |        |
| =tx=     | =garid/open-external-term-here=                                                              | xternal terminal              | -    |        |
| =tm=     | =tmr-with-description=                                                                       | timer                         | -    |        |
| =u=      | =:ignore=                                                                                    | undo ........................ | -    |        |
| =ut=     | =vundo=                                                                                      | vundo                         | -    |        |

**** Bookmark
#+attr_latex: :placement [H]
#+caption: bookmark
#+name: tbl-kbind-bookmarks
| key(s) | function                 | short description              | mode | lambda |
|--------+--------------------------+--------------------------------+------+--------|
| =b=      | =harpoon-quick-menu-hydra= | bookmark-harpoon               | -    |        |
| =B=      | =:ignore t=                | bookmark...................... | -    |        |
| =B1=     | =harpoon-go-to-1=          |                                | -    |        |
| =B2=     | =harpoon-go-to-2=          |                                | -    |        |
| =B3=     | =harpoon-go-to-3=          |                                | -    |        |
| =B4=     | =harpoon-go-to-4=          |                                | -    |        |
| =B5=     | =harpoon-go-to-5=          |                                | -    |        |
| =Ba=     | =harpoon-add-file=         | add-file                       | -    |        |

**** Help related
#+attr_latex: :placement [H]
#+caption: Help for emacs/elisp related
#+name: tbl-kbind-help
| key(s) | function                 | short description               | mode | lambda |
|--------+--------------------------+---------------------------------+------+--------|
| =h=      | =:ignore t=                | help........................... | -    |        |
| =hh=     | =describe-symbol=          | help symbol (elisp)             | -    |        |
| =hH=     | =describe-key=             | help keybinding                 | -    |        |
| =ho=     | =org-info=                 | org-info                        | -    |        |
| =hw=     | =which-key-show-top-level= | which-key                       | -    |        |
| =hm=     | =consult-man=              | man                             | -    |        |
| =hi=     | =Info-goto-node=           | read docs                       | -    |        |

**** Development commands
#+attr_latex: :placement [H]
#+caption: misc. development related
#+name: tbl-kbind-dev
| key(s) | function                      | short description                | mode | lambda |
|--------+-------------------------------+----------------------------------+------+--------|
| =mg=     | =magit-status=                  | magit                            | -    |        |
| =<=      | =recompile=                     | recompile                        | -    |        |
| =sco=    | =corfu-mode=                    | corfu-mode                       | -    |        |
| =se=     | =eglot=                         | eglot                            | -    |        |
| =rg=     | =rg=                            | ripgrep                          | -    |        |
| =g=      | =:ignore t=                     | git............................  | -    |        |
| =gS=     | =git-gutter:stage-hunk=         | stage hunkk                      | -    |        |
| =gs=     | =git-gutter:popup-hunk=         | popup hunk                       | -    |        |
| =gr=     | =git-gutter:update-all-windows= | refresh                          | -    |        |
| =gg=     | =git-gutter-mode=               | gutter-mode                      | -    |        |
| =gn=     | =git-gutter:next-hunk=          | jump-next                        | -    |        |
| =gp=     | =git-gutter:previous-hunk=      | jump-prev                        | -    |        |
| =gd=     | =magit-ediff-compare=           | magit-ediff-compare              | -    |        |
| =P=      | =:ignore=                       | python (inferior)............... | -    |        |
| =Pr=     | =python-shell-restart=          | restart                          | -    |        |
| =PP=     | =run-python=                    | run-python                       | -    |        |
| =Pk=     | =comint-send-eof=               | kill  (also C-c C-d)             | -    |        |

**** Consult related (picking & choosing stuff)
#+attr_latex: :placement [H]
#+caption: consult
#+name: tbl-global-general-keybindings-consult
| key(s) | function               | short description              | mode | lambda |
|--------+------------------------+--------------------------------+------+--------|
| =c=      | =:ignore t=              | consult....................... | -    |        |
| =co=     | =consult-outline=        | consult-outline    [ outline ] | -    |        |
| =ci=     | =consult-imenu=          | consult-imenu                  | -    |        |
| =cm=     | =consult-man=            | consult-man                    | -    |        |
| =cr=     | =consult-ripgrep=        | consult-ripgrep         [ ps ] | -    |        |
| =cR=     | =consult-recent-file=    | consult-recent-files           | -    |        |
| =cf=     | =consult-flymake=        | consult-flymake                | -    |        |
| =cp=     | =consult-project-buffer= | consult-project-buffer  [ pl ] | -    |        |
| =cd=     | =consult-dir=            | consult-dir                    | -    |        |
| =cF=     | =consult-fd=             | consult-fd               [ F ] | -    |        |
| =F=      | =consult-fd=             | consult-fd              [ cF ] | -    |        |
| =ca=     | =consult-org-agenda=     | consult-org-agenda             | -    |        |
| =cg=     | =consult-git-grep=       | consult-git-grep        [ ps ] | -    |        |

**** Project related
#+attr_latex: :placement [H]
#+caption: Project (more like git-repo)
#+name: tbl-global-general-keybindings-project
| key(s) | function                     | short description             | mode | lambda |
|--------+------------------------------+-------------------------------+------+--------|
| =p=      | =:ignore t=                    | project.....................  | -    |        |
| =pr=     | =xref-find-references=         | references                    | -    |        |
| =pR=     | =consult-eglot-symbols=        | references consult            | -    |        |
| =pd=     | =(consult-flymake nil)=        | diagnostic buffer             | -    | y      |
| =pD=     | =consult-flymake=              | diagnostic                    | -    |        |
| =pf=     | =project-find-file=            | find-file                     | -    |        |
| =pz=     | =project-switch-project=       | jump-to-other-proj            | -    |        |
| =ps=     | =consult-git-grep=             | search git files              | -    |        |
| =pS=     | =project-find-regexp=          | search-in-proj                | -    |        |
| =pk=     | =project-kill-buffers=         | kill-buf-proj                 | -    |        |
| =pl=     | =consult-project-buffer=       | list-buf-proj                 | -    |        |
| =pc=     | =project-recompile=            |                               | -    |        |
| =pqrr=   | =project-query-replace-regexp= |                               | -    |        |
| =pv=     | =consult-imenu=                | variables                     | -    |        |
| =v=      | =:ignore t=                    | variables.................... | -    |        |
| =vq=     | =format-all-buffer=            | format-buffer                 | -    |        |
| =vr=     | =eglot-rename=                 | rename variable               | -    |        |

**** Denote related
#+attr_latex: :placement [H]
#+caption: Denote
#+name: tbl-global-general-keybindings-denote
| key(s) | function                             | short description            | mode | lambda |
|--------+--------------------------------------+------------------------------+------+--------|
| =n=      | =:ignore t=                            | note........................ | -    |        |
| =nr=     | =denote-rename-file=                   | rename                       | -    |        |
| =nR=     | =denote-rename-file-date=              | rename with date             | -    |        |
| =nf=     | =denote-silo-open-or-create=           | find                         | -    |        |
| =nd=     | =denote-silo-dired=                    | dired                        | -    |        |
| =nj=     | =denote-journal-new-entry=             | journal                      | -    |        |
| =nJ=     | =denote-journal-new-or-existing-entry= | Journal-find                 | -    |        |
| =nil=    | =denote-insert-link=                   | insert-link                  | -    |        |
| =nij=    | =denote-journal-link-or-create-entry=  | insert-journal-link          | -    |        |
| =nt=     | =denote-template=                      | template                     | -    |        |
| =nI=     | =garid/denote-node-insert-immediate=   | Insert-note                  | -    |        |
| =ns=     | =consult-denote-grep=                  | live-grep                    | -    |        |
| =nF=     | =consult-denote-find=                  | consult-denote-find          | -    |        |
| =nl=     | =:ignore t=                            | denote link................. | -    |        |
| =nli=    | =denote-insert-link=                   | link insert                  | -    |        |
| =nlb=    | =denote-find-backlink=                 | find-backlink                | -    |        |
| =nlf=    | =denote-find-link=                     | find-forward-link            | -    |        |
| =nlB=    | =denote-backlinks=                     | backlink                     | -    |        |
| =nlF=    | =denote-link=                          | forward-link                 | -    |        |
| =nla=    | =denote-add-links=                     | add-links regex              | -    |        |

**** Roam related
#+attr_latex: :placement [H]
#+caption: Roam
#+name: tbl-global-general-keybindings-roam
| key(s) | function                                                       | short description                    | mode | lambda |
|--------+----------------------------------------------------------------+--------------------------------------+------+--------|
| =r=      | =:ignore t=                                                      | roam........................         | -    |        |
| =rr=     | =(message "Current org-roam-directory = %s" org-roam-directory)= | show directory                       | -    | y      |
| =rc=     | =garid/choose-roam-directory=                                    | roam chande directory                | -    |        |
| =rd=     | =(dired org-roam-directory)=                                     | dired                                | -    | y      |
| =rs=     | =consult-org-roam-search=                                        | consult-org-roam-search              | -    |        |
| =rf=     | =consult-org-roam-file-find=                                     | consult-org-roam-file-find           | -    |        |
| =rI=     | =garid/org-roam-node-insert-immediate=                           | garid/org-roam-node-insert-immediate | -    |        |
| =rlb=    | =consult-org-roam-backlinks=                                     | consult-org-roam-backlinks           | -    |        |
| =rlf=    | =consult-org-roam-forward-links=                                 | consult-org-roam-forward-links       | -    |        |
| =rlB=    | =consult-org-roam-backlinks-recursive=                           | consult-org-roam-backlinks-recursive | -    |        |
| =rli=    | =org-roam-node-insert=                                           | org-roam-node-insert                 | -    |        |
| =rui=    | =org-roam-ui-open=                                               | org-roam-ui-open                     | -    |        |
| =rta=    | =org-roam-tag-add=                                               | org-roam-tag-add                     | -    |        |
| =rtr=    | =org-roam-tag-remove=                                            | org-roam-tag-remove                  | -    |        |
| =rbt=    | =org-roam-buffer-toggle=                                         | org-roam-buffer-toggle               | -    |        |

**** org related
#+attr_latex: :placement [H]
#+caption: Org related stuffs
#+name: tbl-global-general-keybindings-org-mode-related
| key(s) | function                                  | short description               | mode | lambda |
|--------+-------------------------------------------+---------------------------------+------+--------|
| =o=      | =:ignore t=                                 | org............................ | -    |        |
| =oo=     | =org-open-at-point=                         | open                            | org  |        |
| =oO=     | =garid/jump-label-def-of-ref-at-point-word= | open ref def                    | org  |        |
| =od=     | =garid/open-org-link-at-point-with-dired=   | directory-open                  | org  |        |
| =omm=    | =org-modern-mode=                           | org-modern-mode                 | org  |        |
| =,=      | =org-ctrl-c-ctrl-c=                         | C-c C-c                         | org  |        |

**** org table related
#+attr_latex: :placement [H]
#+caption: Org related stuffs
#+name: tbl-global-general-keybindings-org-tbl-related
| key(s) | function                             | short description            | mode | lambda |
|--------+--------------------------------------+------------------------------+------+--------|
| =oT=     | =:ignore t=                            | table....................... | -    |        |
| =oTm=    | =orgtbl-mode=                          | mode                         | -    |        |
| =oTc=    | =orgtbl-create-or-convert-from-region= | create                       | -    |        |
| =oTT=    | =org-table-toggle-column-width=        | toggle-hide-column           | -    |        |
| =oTC=    | =org-table-toggle-coordinate-overlays= | coordinate                   | -    |        |
| =oTx=    | =org-table-export=                     | export as csv file           | org  |        |
| =oTs=    | =org-table-sum=                        | sum                          | org  |        |
| =oTi=    | =:ignore t=                            | insert...................... | org  |        |
| =oTic=   | =org-table-insert-column=              | column                       | org  |        |
| =oTir=   | =org-table-insert-row=                 | row                          | org  |        |

**** org-subtree operations
#+attr_latex: :placement [H]
#+caption: in org-file, frequent commands
#+name: tbl-orgmode-general-keybindings-freq
| key(s) | function                                        | short description            | mode | lambda |
|--------+-------------------------------------------------+------------------------------+------+--------|
| =os=     | =:ignore t=                                       | subtree..................... | org  |        |
| =osy=    | =org-copy-subtree=                                | yank (verbatim copy)         | org  |        |
| =osa=    | =(org-archive-subtree-default-with-confirmation)= | archive                      | org  | y      |
| =osY=    | =org-id-copy=                                     | yank (ID)                    | org  |        |
| =osv=    | =org-mark-element=                                | visually select element      | org  |        |
| =osm=    | =org-refile=                                      | move/refile                  | org  |        |
| =osd=    | =org-cut-subtree=                                 | delete (aka cut)             | org  |        |
| =ost=    | =org-toggle-narrow-to-subtree=                    | toggle narrow                | org  |        |
| =osn=    | =org-num-mode=                                    | num-mode                     | org  |        |
| =oss=    | =org-sort=                                        | sort                         | org  |        |
| =osp=    | =org-set-property=                                | property                     | org  |        |
| =osI=    | =org-indent-mode=                                 | indent-mode                  | org  |        |
| =ose=    | =org-set-effort=                                  | org-set-effort               | org  |        |
|--------+-------------------------------------------------+------------------------------+------+--------|
| =osi=    | =:ignore t=                                       | insert heading.............. | org  |        |
| =osia=   | =org-insert-heading-after-current=                | after                  C-RET | org  |        |
| =osih=   | =org-insert-heading=                              | heading                M-RET | org  |        |
| =osis=   | =org-insert-subheading=                           | subheading                   | org  |        |
| =osiH=   | =org-insert-todo-heading=                         | heading         todo M-S-RET | org  |        |
| =osiA=   | =org-insert-todo-heading-respect-content=         | After           todo C-S-RET | org  |        |
| =osiS=   | =org-insert-todo-subheading=                      | subheading      todo         | org  |        |


| =osT= | =org-tidy-mode= | tidy-mode | org |   |

**** org-agenda/calendar/todo related
#+attr_latex: :placement [H]
#+caption: agenda-todo-schedule
#+name: tbl-orgmode-general-keybindings-todo
| key(s) | function      | short description            | mode | lambda |
|--------+---------------+------------------------------+------+--------|
| =oc=     | =org-capture=   | capture                      | -    |        |
| =ot=     | =org-todo=      | todo                         | org  |        |
|--------+---------------+------------------------------+------+--------|
| =oa=     | =:ignore t=     | agenda...................... | -    |        |
| =oag=    | =org-agenda=    | agenda                       | -    |        |
| =oab=    | =org-timeblock= | block                        | -    |        |
| =oas=    | =org-schedule=  | schedule                     | org  |        |
| =oad=    | =org-deadline=  | deadline                     | org  |        |
| =oac=    | =org-clock-in=  | clock in                     | org  |        |
| =oaC=    | =org-clock-out= | clock in                     | org  |        |

**** org jumping around or finding things
#+attr_latex: :placement [H]
#+caption: jumping or finding stuff in org file
#+name: tbl-orgmode-general-keybindings-find
| key(s) | function                        | short description         | mode | lambda |
|--------+---------------------------------+---------------------------+------+--------|
| =of=     | =:ignore t=                       | find..................... | org  |        |
| =ofh=    | =consult-org-heading=             | heading                   | org  |        |
| =ofn=    | =(consult-line "^#+name"   )=     | named table/eq/src        | org  | y      |
| =ofr=    | =(consult-line "^#+result" )=     | result        /src        | org  | y      |
| =ofs=    | =(consult-line "^#+begin_" )=     | source src-block          | org  | y      |
| =ofl=    | =(consult-line "\\\\label{.*}" )= | label                     | org  | y      |
| =ofr=    | =(consult-line "\\\\ref{.*}" )=   | ref                       | org  | y      |
| =j=      | =org-next-block=                  | jump to next src-block    | org  |        |
| =k=      | =org-previous-block=              | jump to prev src-block    | org  |        |

**** org-export related
#+attr_latex: :placement [H]
#+caption: exporting org
#+name: tbl-orgmode-general-keybindings-export
| key(s) | function                         | short description             | mode | lambda |
|--------+----------------------------------+-------------------------------+------+--------|
| =ox=     | =:ignore t=                        | export....................... | org  |        |
| =oxh=    | =org-html-export-to-html=          | html                          | org  |        |
| =oxb=    | =org-beamer-export-to-pdf=         | beamer                        | org  |        |
| =oxp=    | =org-latex-export-to-pdf=          | pdf latex                     | org  |        |
| =oxH=    | =(org-html-export-to-html nil t)=  | Html                 subtree  | org  | y      |
| =oxB=    | =(org-beamer-export-to-pdf nil t)= | beamer               subtree  | org  | y      |
| =oxP=    | =(org-latex-export-to-pdf nil t)=  | pdf latex            subtree  | org  | y      |
| =oxr=    | =org-re-reveal-export-to-html=   | reveal js                     | org  |        |
| =oxo=    | =garid/org-open-pdf=               | pdf open                      | org  |        |
| =oxO=    | =garid/org-open-html=              | html open                     | org  |        |
| =op=     | =org-latex-preview=                | preview                       | org  |        |

**** org-link related
#+attr_latex: :placement [H]
#+caption: org-link related
#+name: tbl-orgmode-general-keybindings-link
| key(s) | function                         | short description            | mode | lambda |
|--------+----------------------------------+------------------------------+------+--------|
| =ol=     | =:ignore t=                        | link........................ | org  |        |
| =old=    | =garid/org-toggle-link-n-emphasis= | description-toggle           | org  |        |
| =oli=    | =org-insert-link=                  | insert                       | org  |        |
| =oln=    | =org-next-link=                    | next-link                    | org  |        |
| =olp=    | =org-previous-link=                | previous-link                | org  |        |
| =olo=    | =org-open-at-point=                | open (same as SPC o o)       | org  |        |
| =olf=    | =org-footnote-new=                 | footnote-new                 | org  |        |
| =olF=    | =org-footnote-action=              | Footnote-action              | org  |        |
| =olc=    | =org-cite-insert=                  | citation                     | org  |        |
| =oll=    | =org-lint=                         | lint                         | org  |        |

**** org-image related
#+attr_latex: :placement [H]
#+caption: handing images in org-file
#+name: tbl-orgmode-general-keybindings-img
| key(s) | function                                | short description            | mode | lambda |
|--------+-----------------------------------------+------------------------------+------+--------|
| =oi=     | =:ignore t=                               | image....................... | org  |        |
| =oii=    | =(insert "[[edraw:]]")=                   | inline edraw                 | org  | y      |
| =oic=    | =org-ipe-insert-drawing=                  | create ipe-svg               | org  |        |
| =oip=    | =org-download-clipboard=                  | paste clipboard              | org  |        |
| =oiP=    | =org-download-image=                      | Paste from-path              | org  |        |
| =oid=    | =org-download-delete=                     | delete file                  | org  |        |
| =oie=    | =edraw-org-edit-regular-file-link=        | edit edraw                   | org  |        |
| =oiE=    | =org-download-edit=                       | Edit externally              | org  |        |
| =oir=    | =org-download-rename-at-point=            | rename file                  | org  |        |
| =oit=    | =garid/org-toggle-display-images-n-edraw= | toggle shot/hide image       | org  |        |
|--------+-----------------------------------------+------------------------------+------+--------|
| =ois=    | =:ignore t=                               | size........................ | org  |        |
| =oisn=   | =(setq org-image-actual-width 1.0)=       | normal 800px                 | org  | y      |
| =oisb=   | =(setq org-image-actual-width 2.0)=       | big    1500px                | org  | y      |
| =oiss=   | =(setq org-image-actual-width 0.5)=       | small  400px                 | org  | y      |

*** Converting tables actual keybinding
**** General.el config
#+begin_src emacs-lisp
(use-package general
  :config (general-evil-setup t)

  ;; Keybindings for everywhere
  (general-create-definer garids-keybind/for-all-modes
    :keymaps  '(normal visual emacs)
    :prefix         "SPC"
    :global-prefix  "C-SPC")

  ;; Keybindings inside Org-mode-map
  (general-create-definer garids-keybind/in-org-mode
    :states '(normal visual)
    :keymaps '(org-mode-map)
    :prefix        "SPC"
    :global-prefix "C-SPC")

  (general-create-definer garids-keybind/easier-window-surfing
    :keymaps  '(normal visual emacs insert)
    :prefix         "<f2>"
    :global-prefix  "C-<f2>")
  )
#+end_src
**** Script that converts previous org-tables into actual emacs configuration
:PROPERTIES:
:header-args:  :var tbl_01=tbl-kbinding-file-n-dired
:header-args+: :var tbl_02=tbl-global-general-keybindings-org-mode-related
:header-args+: :var tbl_03=tbl-kbind-zconvenients
:header-args+: :var tbl_04=tbl-kbind-sys-related
:header-args+: :var tbl_05=tbl-global-general-keybindings-denote
:header-args+: :var tbl_06=tbl-kbind-help
:header-args+: :var tbl_07=tbl-global-general-keybindings-project
:header-args+: :var tbl_08=tbl-kbind-bookmarks
:header-args+: :var tbl_09=tbl-global-general-keybindings-consult
:header-args+: :var tbl_10=tbl-kbind-buffer-related
:header-args+: :var tbl_11=tbl-kbind-dev
:header-args+: :var tbl_12=tbl-global-general-keybindings-org-tbl-related
:header-args+: :var tbl_13=tbl-orgmode-general-keybindings-freq
:header-args+: :var tbl_14=tbl-orgmode-general-keybindings-todo
:header-args+: :var tbl_15=tbl-orgmode-general-keybindings-find
:header-args+: :var tbl_16=tbl-orgmode-general-keybindings-export
:header-args+: :var tbl_17=tbl-orgmode-general-keybindings-link
:header-args+: :var tbl_18=tbl-orgmode-general-keybindings-img
:header-args+: :var tbl_19=tbl-global-general-keybindings-roam
:END:
#+caption: converting
#+name: src_that_converts_key_tables
#+begin_src elisp :wrap src emacs-lisp :tangle no
(setq tblall (append tbl_01 tbl_02 tbl_03 tbl_04 tbl_05 tbl_06 tbl_07 tbl_08 tbl_09 tbl_10
                     tbl_11 tbl_12 tbl_13 tbl_14 tbl_15 tbl_16 tbl_17 tbl_18 tbl_19))



(setq tbl_all_kbind (seq-filter (lambda (x) (string= (nth 3 x) "-"))   tblall))
(setq tbl_org_kbind (seq-filter (lambda (x) (string= (nth 3 x) "org")) tblall))



(defun remove-equal-from-both-sides (str)
  "Remove the tilde (~) character from the beginning and end of STR."
  (if (string-match "\\`=\\(.*?\\)=\\'" str)  ;;
      ;; \\`~ front
      ;; \\(.*?\\) capture group
      ;; ~\\'  end?
      (match-string 1 str)
    str))


(concat
 "(garids-keybind/for-all-modes\n"
 (mapconcat (lambda (row)
              (format "  \"%s\" '(%s :which-key \"%s\")"
                      (remove-equal-from-both-sides (nth 0 row))
                      (if (string= (nth 4 row) "y")
                          (format "(lambda () (interactive) %s )"
                                  (remove-equal-from-both-sides (nth 1 row))) ;; for anon functions
                        (remove-equal-from-both-sides (nth 1 row)))           ;; for normal functions
                      (nth 2 row)))
            tbl_all_kbind "\n"
            )
 "\n)\n\n"
 "(garids-keybind/in-org-mode\n"
 (mapconcat (lambda (row)
              (format "  \"%s\" '(%s :which-key \"%s\")"
                      (remove-equal-from-both-sides (nth 0 row))
                      (if (string= (nth 4 row) "y")
                          (format "(lambda () (interactive) %s )"
                                  (remove-equal-from-both-sides (nth 1 row))) ;; for anon functions
                        (remove-equal-from-both-sides (nth 1 row)))           ;; for normal functions
                      (nth 2 row)))
            tbl_org_kbind "\n"
            )
 "\n)\n"
 )
#+end_src

**** Converted config from tables

#+RESULTS: src_that_converts_key_tables
#+begin_src emacs-lisp
(garids-keybind/for-all-modes
  "SPC" '(execute-extended-command :which-key "M-x")
  "f" '((lambda () (interactive) (if (project-current) (project-find-file) (call-interactively #'find-file)) ) :which-key "find-file")
  "d" '(dired-jump :which-key "directory")
  "D" '(:ignore t :which-key "Dired..............")
  "Ds" '(dired :which-key "simple")
  "Dp" '(dired-preview-mode :which-key "preview")
  "Dw" '(wdired-change-to-wdired-mode :which-key "wdired")
  "o" '(:ignore t :which-key "org............................")
  "z" '(:ignore t :which-key "conveniences....................")
  "za" '(align-regexp :which-key "align")
  "zr" '(replace-regexp :which-key "replace")
  "zh" '(highlight-symbol-at-point :which-key "highlight-on")
  "zH" '(unhighlight-regexp :which-key "highlight-off")
  "zs" '(:ignore t :which-key "spell............................")
  "zsw" '(ispell-word :which-key "word")
  "zsr" '(ispell-region :which-key "region")
  "zsC" '(ispell-comments-and-strings :which-key "comment-full")
  "zsc" '(ispell-comment-or-string-at-point :which-key "comment-here")
  "zsb" '(ispell-buffer :which-key "buffer")
  "zsm" '(ispell-message :which-key "message")
  "zsq" '(ispell-kill-ispell :which-key "quit")
  "zsl" '(ispell-change-dictionary :which-key "language en/mn")
  "zst" '(mw-thesaurus-lookup-at-point :which-key "thesaurus current word")
  "zsT" '(mw-thesaurus-lookup :which-key "thesaurus")
  "ZQ" '(kill-emacs :which-key "kill Emacs")
  "s" '(:ignore t :which-key "system.......................")
  "srf" '(consult-recent-file :which-key "recent-f.iles")
  "sl" '(:ignore t :which-key "line.........................")
  "slm" '(scroll-lock-mode :which-key "scroll-lock-mode")
  "slv" '(global-display-fill-column-indicator-mode :which-key "vertical-line")
  "sln" '(display-line-numbers-mode :which-key "number toggle")
  "slr" '(ruler-mode :which-key "ruler mode")
  "scl" '((lambda () (interactive) (global-command-log-mode) (clm/open-command-log-buffer) ) :which-key "command log mode")
  "sw" '(whitespace-mode :which-key "whitespace")
  "sg" '(:ignore t :which-key "garid")
  "sgf" '(garid/distraction-free-on :which-key "focus")
  "sgr" '(garid/distraction-free-off :which-key "reset")
  "O" '(:ignore t :which-key "open........................")
  "Oe" '((lambda () (interactive) (find-file "~/.config/emacs/init.org") ) :which-key "emacs init.org")
  "OE" '((lambda () (interactive) (find-file "~/.config/emacs/init.el") ) :which-key "emacs init.el")
  "Ob" '((lambda () (interactive) (find-file (nth 0 org-cite-global-bibliography)) ) :which-key "bibliography")
  "Op" '((lambda () (interactive) (find-file "~/BrainDump/bookshelf/") ) :which-key "pdf")
  "Oc" '(citar-open :which-key "citaiton")
  "OO" '((lambda () (interactive) (find-file org-default-notes-file) ) :which-key "org capture")
  "Oi" '((lambda () (interactive) (find-file "~/BrainDump/gtd/inbox.org") ) :which-key "inbox")
  "Om" '((lambda () (interactive) (find-file "~/BrainDump/gtd/main.org") ) :which-key "main")
  "Or" '((lambda () (interactive) (find-file (concat denote-directory "/phd/20240814T113502--00-garids-phd-index__phd.org")) ) :which-key "research index")
  "t" '(:ignore t :which-key "terminal.....................")
  "te" '(eshell :which-key "eshell emacs-shell")
  "tv" '(vterm :which-key "vterm  vterm")
  "tx" '(garid/open-external-term-here :which-key "xternal terminal")
  "tm" '(tmr-with-description :which-key "timer")
  "u" '(:ignore :which-key "undo ........................")
  "ut" '(vundo :which-key "vundo")
  "n" '(:ignore t :which-key "note........................")
  "nr" '(denote-rename-file :which-key "rename")
  "nR" '(denote-rename-file-date :which-key "rename with date")
  "nf" '(denote-silo-open-or-create :which-key "find")
  "nd" '(denote-silo-dired :which-key "dired")
  "nj" '(denote-journal-new-entry :which-key "journal")
  "nJ" '(denote-journal-new-or-existing-entry :which-key "Journal-find")
  "nil" '(denote-insert-link :which-key "insert-link")
  "nij" '(denote-journal-link-or-create-entry :which-key "insert-journal-link")
  "nt" '(denote-template :which-key "template")
  "nI" '(garid/denote-node-insert-immediate :which-key "Insert-note")
  "ns" '(consult-denote-grep :which-key "live-grep")
  "nF" '(consult-denote-find :which-key "consult-denote-find")
  "nl" '(:ignore t :which-key "denote link.................")
  "nli" '(denote-insert-link :which-key "link insert")
  "nlb" '(denote-find-backlink :which-key "find-backlink")
  "nlf" '(denote-find-link :which-key "find-forward-link")
  "nlB" '(denote-backlinks :which-key "backlink")
  "nlF" '(denote-link :which-key "forward-link")
  "nla" '(denote-add-links :which-key "add-links regex")
  "h" '(:ignore t :which-key "help...........................")
  "hh" '(describe-symbol :which-key "help symbol (elisp)")
  "hH" '(describe-key :which-key "help keybinding")
  "ho" '(org-info :which-key "org-info")
  "hw" '(which-key-show-top-level :which-key "which-key")
  "hm" '(consult-man :which-key "man")
  "hi" '(Info-goto-node :which-key "read docs")
  "p" '(:ignore t :which-key "project.....................")
  "pr" '(xref-find-references :which-key "references")
  "pR" '(consult-eglot-symbols :which-key "references consult")
  "pd" '((lambda () (interactive) (consult-flymake nil) ) :which-key "diagnostic buffer")
  "pD" '(consult-flymake :which-key "diagnostic")
  "pf" '(project-find-file :which-key "find-file")
  "pz" '(project-switch-project :which-key "jump-to-other-proj")
  "ps" '(consult-git-grep :which-key "search git files")
  "pS" '(project-find-regexp :which-key "search-in-proj")
  "pk" '(project-kill-buffers :which-key "kill-buf-proj")
  "pl" '(consult-project-buffer :which-key "list-buf-proj")
  "pc" '(project-recompile :which-key "")
  "pqrr" '(project-query-replace-regexp :which-key "")
  "pv" '(consult-imenu :which-key "variables")
  "v" '(:ignore t :which-key "variables....................")
  "vq" '(format-all-buffer :which-key "format-buffer")
  "vr" '(eglot-rename :which-key "rename variable")
  "b" '(harpoon-quick-menu-hydra :which-key "bookmark-harpoon")
  "B" '(:ignore t :which-key "bookmark......................")
  "B1" '(harpoon-go-to-1 :which-key "")
  "B2" '(harpoon-go-to-2 :which-key "")
  "B3" '(harpoon-go-to-3 :which-key "")
  "B4" '(harpoon-go-to-4 :which-key "")
  "B5" '(harpoon-go-to-5 :which-key "")
  "Ba" '(harpoon-add-file :which-key "add-file")
  "c" '(:ignore t :which-key "consult.......................")
  "co" '(consult-outline :which-key "consult-outline    [ outline ]")
  "ci" '(consult-imenu :which-key "consult-imenu")
  "cm" '(consult-man :which-key "consult-man")
  "cr" '(consult-ripgrep :which-key "consult-ripgrep         [ ps ]")
  "cR" '(consult-recent-file :which-key "consult-recent-files")
  "cf" '(consult-flymake :which-key "consult-flymake")
  "cp" '(consult-project-buffer :which-key "consult-project-buffer  [ pl ]")
  "cd" '(consult-dir :which-key "consult-dir")
  "cF" '(consult-fd :which-key "consult-fd               [ F ]")
  "F" '(consult-fd :which-key "consult-fd              [ cF ]")
  "ca" '(consult-org-agenda :which-key "consult-org-agenda")
  "cg" '(consult-git-grep :which-key "consult-git-grep        [ ps ]")
  "l" '(consult-buffer :which-key "list-buffer")
  "L" '(:ignore t :which-key "buffer.....................")
  "Lr" '(revert-buffer-quick :which-key "revert (reload)")
  "Le" '(eval-buffer :which-key "evaluate buffer")
  "Li" '(ibuffer :which-key "ibuffer")
  "Ln" '(rename-buffer :which-key "rename")
  "L<" '(switch-to-prev-buffer :which-key "<prev")
  "L>" '(switch-to-next-buffer :which-key ">next")
  "Ld" '(crux-delete-file-and-buffer :which-key "delete")
  "Lc" '(clone-indirect-buffer :which-key "clone")
  "Ls" '(crux-create-scratch-buffer :which-key "scratch-buffer")
  "Lh" '(buf-move-left :which-key "move left")
  "Lj" '(buf-move-down :which-key "move down")
  "Lk" '(buf-move-up :which-key "move up")
  "Ll" '(buf-move-right :which-key "move right")
  "LL" '(tear-off-window :which-key "tear window to frame")
  "mg" '(magit-status :which-key "magit")
  "<" '(recompile :which-key "recompile")
  "sco" '(corfu-mode :which-key "corfu-mode")
  "se" '(eglot :which-key "eglot")
  "rg" '(rg :which-key "ripgrep")
  "g" '(:ignore t :which-key "git............................")
  "gS" '(git-gutter:stage-hunk :which-key "stage hunkk")
  "gs" '(git-gutter:popup-hunk :which-key "popup hunk")
  "gr" '(git-gutter:update-all-windows :which-key "refresh")
  "gg" '(git-gutter-mode :which-key "gutter-mode")
  "gn" '(git-gutter:next-hunk :which-key "jump-next")
  "gp" '(git-gutter:previous-hunk :which-key "jump-prev")
  "gd" '(magit-ediff-compare :which-key "magit-ediff-compare")
  "P" '(:ignore :which-key "python (inferior)...............")
  "Pr" '(python-shell-restart :which-key "restart")
  "PP" '(run-python :which-key "run-python")
  "Pk" '(comint-send-eof :which-key "kill  (also C-c C-d)")
  "oT" '(:ignore t :which-key "table.......................")
  "oTm" '(orgtbl-mode :which-key "mode")
  "oTc" '(orgtbl-create-or-convert-from-region :which-key "create")
  "oTT" '(org-table-toggle-column-width :which-key "toggle-hide-column")
  "oTC" '(org-table-toggle-coordinate-overlays :which-key "coordinate")
  "oc" '(org-capture :which-key "capture")
  "oa" '(:ignore t :which-key "agenda......................")
  "oag" '(org-agenda :which-key "agenda")
  "oab" '(org-timeblock :which-key "block")
  "r" '(:ignore t :which-key "roam........................")
  "rr" '((lambda () (interactive) (message "Current org-roam-directory = %s" org-roam-directory) ) :which-key "show directory")
  "rc" '(garid/choose-roam-directory :which-key "roam chande directory")
  "rd" '((lambda () (interactive) (dired org-roam-directory) ) :which-key "dired")
  "rs" '(consult-org-roam-search :which-key "consult-org-roam-search")
  "rf" '(consult-org-roam-file-find :which-key "consult-org-roam-file-find")
  "rI" '(garid/org-roam-node-insert-immediate :which-key "garid/org-roam-node-insert-immediate")
  "rlb" '(consult-org-roam-backlinks :which-key "consult-org-roam-backlinks")
  "rlf" '(consult-org-roam-forward-links :which-key "consult-org-roam-forward-links")
  "rlB" '(consult-org-roam-backlinks-recursive :which-key "consult-org-roam-backlinks-recursive")
  "rli" '(org-roam-node-insert :which-key "org-roam-node-insert")
  "rui" '(org-roam-ui-open :which-key "org-roam-ui-open")
  "rta" '(org-roam-tag-add :which-key "org-roam-tag-add")
  "rtr" '(org-roam-tag-remove :which-key "org-roam-tag-remove")
  "rbt" '(org-roam-buffer-toggle :which-key "org-roam-buffer-toggle")
)

(garids-keybind/in-org-mode
  "oo" '(org-open-at-point :which-key "open")
  "oO" '(garid/jump-label-def-of-ref-at-point-word :which-key "open ref def")
  "od" '(garid/open-org-link-at-point-with-dired :which-key "directory-open")
  "omm" '(org-modern-mode :which-key "org-modern-mode")
  "," '(org-ctrl-c-ctrl-c :which-key "C-c C-c")
  "oTx" '(org-table-export :which-key "export as csv file")
  "oTs" '(org-table-sum :which-key "sum")
  "oTi" '(:ignore t :which-key "insert......................")
  "oTic" '(org-table-insert-column :which-key "column")
  "oTir" '(org-table-insert-row :which-key "row")
  "os" '(:ignore t :which-key "subtree.....................")
  "osy" '(org-copy-subtree :which-key "yank (verbatim copy)")
  "osa" '((lambda () (interactive) (org-archive-subtree-default-with-confirmation) ) :which-key "archive")
  "osY" '(org-id-copy :which-key "yank (ID)")
  "osv" '(org-mark-element :which-key "visually select element")
  "osm" '(org-refile :which-key "move/refile")
  "osd" '(org-cut-subtree :which-key "delete (aka cut)")
  "ost" '(org-toggle-narrow-to-subtree :which-key "toggle narrow")
  "osn" '(org-num-mode :which-key "num-mode")
  "oss" '(org-sort :which-key "sort")
  "osp" '(org-set-property :which-key "property")
  "osI" '(org-indent-mode :which-key "indent-mode")
  "ose" '(org-set-effort :which-key "org-set-effort")
  "osi" '(:ignore t :which-key "insert heading..............")
  "osia" '(org-insert-heading-after-current :which-key "after                  C-RET")
  "osih" '(org-insert-heading :which-key "heading                M-RET")
  "osis" '(org-insert-subheading :which-key "subheading")
  "osiH" '(org-insert-todo-heading :which-key "heading         todo M-S-RET")
  "osiA" '(org-insert-todo-heading-respect-content :which-key "After           todo C-S-RET")
  "osiS" '(org-insert-todo-subheading :which-key "subheading      todo")
  "ot" '(org-todo :which-key "todo")
  "oas" '(org-schedule :which-key "schedule")
  "oad" '(org-deadline :which-key "deadline")
  "oac" '(org-clock-in :which-key "clock in")
  "oaC" '(org-clock-out :which-key "clock in")
  "of" '(:ignore t :which-key "find.....................")
  "ofh" '(consult-org-heading :which-key "heading")
  "ofn" '((lambda () (interactive) (consult-line "^#+name"   ) ) :which-key "named table/eq/src")
  "ofr" '((lambda () (interactive) (consult-line "^#+result" ) ) :which-key "result        /src")
  "ofs" '((lambda () (interactive) (consult-line "^#+begin_" ) ) :which-key "source src-block")
  "ofl" '((lambda () (interactive) (consult-line "\\\\label{.*}" ) ) :which-key "label")
  "ofr" '((lambda () (interactive) (consult-line "\\\\ref{.*}" ) ) :which-key "ref")
  "j" '(org-next-block :which-key "jump to next src-block")
  "k" '(org-previous-block :which-key "jump to prev src-block")
  "ox" '(:ignore t :which-key "export.......................")
  "oxh" '(org-html-export-to-html :which-key "html")
  "oxb" '(org-beamer-export-to-pdf :which-key "beamer")
  "oxp" '(org-latex-export-to-pdf :which-key "pdf latex")
  "oxH" '((lambda () (interactive) (org-html-export-to-html nil t) ) :which-key "Html                 subtree")
  "oxB" '((lambda () (interactive) (org-beamer-export-to-pdf nil t) ) :which-key "beamer               subtree")
  "oxP" '((lambda () (interactive) (org-latex-export-to-pdf nil t) ) :which-key "pdf latex            subtree")
  "oxr" '(org-re-reveal-export-to-html :which-key "reveal js")
  "oxo" '(garid/org-open-pdf :which-key "pdf open")
  "oxO" '(garid/org-open-html :which-key "html open")
  "op" '(org-latex-preview :which-key "preview")
  "ol" '(:ignore t :which-key "link........................")
  "old" '(garid/org-toggle-link-n-emphasis :which-key "description-toggle")
  "oli" '(org-insert-link :which-key "insert")
  "oln" '(org-next-link :which-key "next-link")
  "olp" '(org-previous-link :which-key "previous-link")
  "olo" '(org-open-at-point :which-key "open (same as SPC o o)")
  "olf" '(org-footnote-new :which-key "footnote-new")
  "olF" '(org-footnote-action :which-key "Footnote-action")
  "olc" '(org-cite-insert :which-key "citation")
  "oll" '(org-lint :which-key "lint")
  "oi" '(:ignore t :which-key "image.......................")
  "oii" '((lambda () (interactive) (insert "[[edraw:]]") ) :which-key "inline edraw")
  "oic" '(org-ipe-insert-drawing :which-key "create ipe-svg")
  "oip" '(org-download-clipboard :which-key "paste clipboard")
  "oiP" '(org-download-image :which-key "Paste from-path")
  "oid" '(org-download-delete :which-key "delete file")
  "oie" '(edraw-org-edit-regular-file-link :which-key "edit edraw")
  "oiE" '(org-download-edit :which-key "Edit externally")
  "oir" '(org-download-rename-at-point :which-key "rename file")
  "oit" '(garid/org-toggle-display-images-n-edraw :which-key "toggle shot/hide image")
  "ois" '(:ignore t :which-key "size........................")
  "oisn" '((lambda () (interactive) (setq org-image-actual-width 1.0) ) :which-key "normal 800px")
  "oisb" '((lambda () (interactive) (setq org-image-actual-width 2.0) ) :which-key "big    1500px")
  "oiss" '((lambda () (interactive) (setq org-image-actual-width 0.5) ) :which-key "small  400px")
)
#+end_src

**** addon
#+begin_src emacs-lisp
(garids-keybind/easier-window-surfing
  "l" '( windmove-right :which-key "windmove-right")
  "h" '( windmove-left :which-key "windmove-left")
  "j" '( windmove-down :which-key "windmove-down")
  "k" '( windmove-down :which-key "windmove-up")
  "v" '( evil-window-vsplit :which-key "evil-window-vsplit")
  "s" '( evil-window-hsplit :which-key "evil-window-hsplit")
)
#+end_src

* System:
** =dired= - Directory
#+begin_src emacs-lisp
(use-package dired
  :ensure   nil
  :demand   t
  :commands (dired dired-jump)
  :custom ((dired-listing-switches "-agho --group-directories-first")
           (dired-kill-when-opening-new-dired-buffer t))
  :hook     ((dired-mode . denote-dired-mode)
             (dired-mode . dired-omit-mode  )
             (dired-mode . auto-revert-mode ))
  :config
  (evil-collection-define-key 'normal 'dired-mode-map
    "h"          'dired-up-directory
    "l"          'dired-find-file
    " "          'nil
    "N"          'dired-create-directory
    "W"          'wdired-change-to-wdired-mode
    (kbd "C-n")  'mkdir
    (kbd "C-s")  'dired-omit-mode      ;; same keybinding with my lf config
    )

  (when (eq system-type 'berkeley-unix)   ;; change the main ls with gnu ls in bsd
    (setq insert-directory-program "gls"))
  )
#+end_src
** =dired= - Additionals
I don't use these not much
#+begin_src emacs-lisp
(use-package dired-preview
  :ensure t
  :bind (:map dired-preview-mode-map
              ("J" . dired-preview-page-down)
              ("K" . dired-preview-page-up))
  )
#+end_src
** =saveplace= - Save (last) cursor position
This mode saves the last cursor point when you close a file,
and later sets cursor at that point when you open that file.

#+begin_src emacs-lisp
(use-package saveplace
  :ensure nil
  :config (save-place-mode 1))
#+end_src
** =recentf= - Recent files
#+begin_src emacs-lisp
(use-package recentf
  :ensure nil
  :demand t
  :custom
  (recentf-max-menu-items   30)
  (recentf-max-saved-items  30)
  :config
  (recentf-mode 1))
#+end_src
** shell script to open terminal                                                     :shell_script:
#+begin_src bash :tangle garid/open_external_term.sh :shebang "#!/bin/bash"
# Open System termianl $TERMINAL at $1:
# nohup for exitting terminal that executed this script
# other wise terminal that executed this script just hangs there

# if $1 is directory; -> cd to this dir
if [[ -d $1 ]]; then
	notify-send "Emacs external terminal" "Emacs is openning external terminal\n at: $1"
	cd "$1" || return 1
	nohup "$TERMINAL" > /dev/null &
	return 0

# if $1 is file; -> cd to parent dir
elif [[ -f $1 ]]; then
	notify-send "Emacs external terminal" "Emacs is openning external terminal\n near: $1"
	cd "$(dirname "$1")" || return 1
	nohup "$TERMINAL" > /dev/null &
	return 0

# if $1 is neither directory nor file -> fail
else
	notify-send "Emacs external terminal" "$1\nwas not found\nOpening at Home"
	nohup "$TERMINAL" > /dev/null &
	return 0
fi
#+end_src
* email
** reading
#+begin_src emacs-lisp
(use-package notmuch
  :ensure t
  :defer t)
#+end_src

** writting
#+begin_src emacs-lisp
(use-package sendmail
  :ensure nil
  :custom
  (send-mail-function              'sendmail-send-it )
  ;;:w (sendmail-program                "/usr/bin/msmtp"  ) < removed cause of nixos
  (mail-specify-envelope-from      t                 )
  (message-sendmail-envelope-from  'header           )
  (mail-envelope-from              'header           )
  )
#+end_src

** writting with org mode
#+begin_src emacs-lisp
(use-package org-mime
  :custom
  (org-mime-library 'mml)
  (org-mime-export-options '(
                             :with-latex imagemagick
                             :section-numbers nil
                             :with-author nil
                             :with-toc nil)
                           ))
#+end_src

** consulting notmuch
#+begin_src emacs-lisp
(use-package consult-notmuch)
#+end_src

* Misc Packages
** =crux=
#+begin_src emacs-lisp
(use-package crux :ensure t)
#+end_src
** =command-log-mode=
#+begin_src emacs-lisp
(use-package command-log-mode)
#+end_src
** =format-all=
#+begin_src emacs-lisp
(use-package format-all
  :commands format-all-mode
  ;;:hook (prog-mode . format-all-mode)
  :config
  (setq-default format-all-formatters
                '(("C"     (astyle "--mode=c"))
                  ("Shell" (shfmt "-i" "4" "-ci"))
                  ("Python" (ruff "format" "--line-length" "120"))
                  )))
#+end_src
** =popper=
#+begin_src emacs-lisp
(use-package popper
  :ensure t ; or :straight t
  :bind (("C-`"   . popper-toggle      )
         ("M-`"   . popper-cycle       )
         ("C-M-`" . popper-toggle-type )
         :repeat-map garid/popper-repeat
         ("`" .      popper-cycle )
         ("q" .      popper-close-latest )

         )
  :init
  (setq popper-reference-buffers '("\\*Messages\\*"
                                   "\\*eldoc\\*"
                                   "\\*eldoc.*\\*" ;;regex
                                   "\\*Outline.*\\*" ;;regex
                                   "\\*xref\\*"
                                   "\\*Help\\*"
                                   "Output\\*$"
                                   "\\*Async Shell Command\\*"
                                   "\\*devdocs\\*"
                                   "\\*lsp-bridge-doc\\*"
                                   "\\*git-gutter:diff\\*"
                                   "\\*Org Select\\*"
                                   "\\*Org Attach\\*"
                                   "\\*Org Lint\\*"
                                   "\\*git-gutter:.*\\*"
                                   "\\* Merriam-Webster Thesaurus \\*"
                                   "CAPTURE-inbox.org"
                                   "CAPTURE-20230926T010607--todo__todo.org"
                                   help-mode
                                   compilation-mode))
  ;;:config
  (popper-mode      +1)
  (popper-echo-mode +1))
#+end_src
** =hydra=
#+begin_src emacs-lisp
(use-package hydra
  ;; :config
  ;; (defhydra hydra-org-link-jumper ()
  ;;   "zoom"
  ;;   ("n" org-next-link     "next")
  ;;   ("p" org-previous-link "prev"))
  )
#+end_src

** =exercism=
#+begin_src emacs-lisp
(use-package exercism)
#+end_src
** =zoom-window=
#+begin_src emacs-lisp
(use-package zoom-window
  :custom
  (zoom-window-mode-line-color "dark slate gray")
  :bind (("M-F" . zoom-window-zoom)
         :repeat-map garid/windmove-repeat
         ("f" . zoom-window-zoom)
         ("n" . zoom-window-next))
  )
#+end_src
** screen
#+begin_src emacs-lisp
(use-package gif-screencast
  :custom
  (gif-screencast-program "hyprshot")
  (gif-screencast-args '("-m" "window" "-m" "active" "-o" "/" "-f")))
;; this is configured to be on wayland/hyprland
#+end_src
** test karthinks consult reftex                                                             :test:
#+begin_src emacs-lisp
(use-package consult-reftex
  :straight (consult-reftex
             :type git
             :host github
             :branch "master"
             :repo "karthink/consult-reftex"))


(use-package reftex-xref
  :straight (reftex-xref
             :type git
             :host github
             :branch "master"
             :repo "karthink/reftex-xref"))
#+end_src
** garbage-collect
#+begin_src emacs-lisp
(use-package gcmh
  :config (gcmh-mode 1)
  :delight " gb")
#+end_src
** google
#+begin_src emacs-lisp
(use-package google-translate)
(use-package google-this)
#+end_src
* Daemon
#+begin_src emacs-lisp
(use-package server
  :ensure nil
  :hook
  (emacs-startup . (lambda ()
                     (server-start)
                     (call-process-shell-command
                      "notify-send \"Emacs\" \"Emacs Daemon initialized, 'emacsclient -c' should be available.\" &")
                     )))
#+end_src

* Custom set variable:
[[https://www.youtube.com/watch?v=tw2-rI2bxSg&t=1s][Initial idea from Systems crafter]], [[https://emacs.stackexchange.com/a/18785/38482][and code structure from this answer on emacs stackexchange]], and need to set ~enble-local-eval~ to ~t~.

#+begin_src emacs-lisp
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(safe-local-variable-values
   '((eval setq org-download-image-dir
           (file-relative-name
            (concat "./data/"
                    (file-name-as-directory
                     (org-id-get 1))))
           org-ipe-folder org-download-image-dir)
     (eval setq org-download-image-dir
           (file-relative-name
            (concat "./data/"
                    (file-name-as-directory
                     (car
                      (split-string
                       (file-name-base
                        (buffer-file-name))
                       "--")))))
           org-ipe-folder org-download-image-dir)
     (eval setq org-download-image-dir
           (file-relative-name
            (concat "./data/"
                    (file-name-as-directory
                     (org-id-get 1)))))
     (eval setq org-download-image-dir
           (file-relative-name
            (concat "./data/"
                    (file-name-as-directory
                     (car
                      (split-string
                       (file-name-base
                        (buffer-file-name))
                       "--"))))))
     (dired-omit-files . "\\`[.]?#\\|\\`[.][.]?\\'\\|\\.html\\'\\|\\.tex\\'"))))
#+end_src
